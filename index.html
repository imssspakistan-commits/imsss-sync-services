<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMSSS Assessor Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Scrollbar Styles for Review Panel */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #a5b4fc; /* indigo-300 */
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #e0e7ff; /* indigo-100 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex items-center justify-center">
    <div id="root" class="w-full"></div>

    <script>
        // Aliases for React functions
        const { useState, useEffect, useMemo } = React;
        const e = React.createElement;

        // --- GLOBAL UTILITY: Lucide Icons Rendering ---
        const useLucideIcons = () => {
            useEffect(() => {
                lucide.createIcons();
            }, []);
        };
        
        // --- DATA / UTILITY: Maturity Level Mapping ---
        const getMaturityLevel = (averageScore) => {
            if (averageScore >= 3.5) return { name: "Level 4 (Optimizing)", color: "text-green-600", bg: "bg-green-100" };
            if (averageScore >= 2.5) return { name: "Level 3 (Managed)", color: "text-blue-600", bg: "bg-blue-100" };
            if (averageScore >= 1.5) return { name: "Level 2 (Defined)", color: "text-yellow-600", bg: "bg-yellow-100" };
            if (averageScore >= 0.5) return { name: "Level 1 (Initial)", color: "text-orange-600", bg: "bg-orange-100" };
            return { name: "Level 0 (Not Implemented)", color: "text-red-600", bg: "bg-red-100" };
        };

        // --- COMPONENT: Breadcrumb (Step Indicator) ---
        const Breadcrumb = ({ currentStep, onStepClick, isAssessmentStarted, isAssessmentFinished }) => {
            useLucideIcons();
            
            // Define the 4 setup steps
            const steps = [
                { id: 1, name: "Start", icon: "Rocket" },
                { id: 2, name: "Type", icon: "LayoutGrid" },
                { id: 3, name: "Storage", icon: "Database" },
                { id: 4, name: "Review", icon: "CheckCircle" },
            ];
            
            let statusBanner = null;

            if (isAssessmentFinished) {
                 statusBanner = e('div', { className: "text-center text-lg font-bold text-green-600 mb-8 p-3 bg-green-50 rounded-lg shadow-inner" },
                    e('span', { 'data-lucide': "Trophy", className: "inline-block w-5 h-5 mr-2 align-text-bottom" }),
                    "Assessment Complete - View Results"
                );
            } else if (isAssessmentStarted) {
                statusBanner = e('div', { className: "text-center text-lg font-bold text-green-600 mb-8 p-3 bg-green-50 rounded-lg shadow-inner" },
                    e('span', { 'data-lucide': "FlaskConical", className: "inline-block w-5 h-5 mr-2 align-text-bottom" }),
                    "Assessment In Progress"
                );
            }

            if (statusBanner) {
                return statusBanner;
            }

            // Render setup steps
            return e('nav', { className: "flex items-center justify-center space-x-2 mb-8" },
                steps.map((stepItem) => {
                    const isActive = stepItem.id === currentStep;
                    // A step is completed if its ID is less than the current step ID
                    const isCompleted = stepItem.id < currentStep; 
                    
                    const classes = `
                        flex flex-col items-center p-3 rounded-xl transition duration-300 w-1/4
                        ${isActive 
                            ? 'bg-indigo-600 shadow-lg text-white font-bold transform scale-105' 
                            : isCompleted 
                                ? 'bg-indigo-100 text-indigo-700 cursor-pointer hover:bg-indigo-200' 
                                : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                        }
                    `;
                    
                    return e('div', { 
                        key: stepItem.id,
                        onClick: isCompleted ? () => onStepClick(stepItem.id) : null,
                        className: classes
                    },
                        e('span', { 'data-lucide': isCompleted ? "Check" : stepItem.icon, className: "w-6 h-6 mb-1" }),
                        e('span', { className: "text-xs font-medium" }, `Step ${stepItem.id}: ${stepItem.name}`)
                    );
                })
            );
        };

        // --- COMPONENT: TermsOfService (Step 1) ---
        const TermsOfService = ({ onAccept }) => {
            useLucideIcons();
            
            return e('div', { className: "p-8 bg-white rounded-xl shadow-lg border border-gray-200" },
                e('h2', { className: "text-3xl font-bold text-indigo-700 mb-4 flex items-center" }, 
                    e('span', { 'data-lucide': "FileText", className: "inline-block w-6 h-6 mr-3" }),
                    "Step 1: Terms of Service"
                ),
                e('div', { className: "h-64 overflow-y-auto p-4 bg-gray-50 border rounded-lg text-sm text-gray-600 leading-relaxed custom-scroll" },
                    e('p', { className: "mb-3 font-semibold" }, "Welcome to the IMSSS Assessor."),
                    e('p', { className: "mb-3" }, "This tool is designed to help you perform a preliminary assessment based on security maturity levels. By accepting these terms, you acknowledge the following:"),
                    e('ul', { className: "list-disc list-inside ml-4 space-y-2" },
                        e('li', null, "The results are for **informational purposes only** and do not constitute a certified security audit."),
                        e('li', null, "The data collected will be stored based on your chosen persistence mechanism (e.g., Local Storage or Server)."),
                        e('li', null, "You are responsible for the accuracy of the information provided during the assessment."),
                        e('li', null, "The assessment framework is based on the **IMSSS** (Internal Maturity Self-Scoring System) model."),
                    ),
                    e('p', { className: "mt-4 font-semibold text-red-600" }, "Do not use this tool with highly sensitive or confidential information unless you are fully aware of and accept the risks associated with the selected persistence method."),
                ),
                e('div', { className: "flex justify-end mt-6" },
                    e('button', {
                        onClick: onAccept,
                        className: "px-8 py-3 text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg shadow-md transition duration-150 flex items-center"
                    }, 
                        "Accept and Continue",
                        e('span', { 'data-lucide': "ArrowRight", className: "inline-block w-4 h-4 ml-2" })
                    )
                )
            );
        };

        // --- COMPONENT: Step1 (Assessment Type - Step 2) ---
        const Step1 = ({ onNext, assessmentType, setAssessmentType }) => {
            useLucideIcons();
            
            // Using the Follow-up/Ad-Hoc options as confirmed stable.
            const assessmentOptions = [
                { id: 'baseline', name: 'Baseline Assessment', icon: 'HardHat', 
                  description: 'A quick, high-level review of foundational security controls. Focuses on critical gaps.' },
                { id: 'follow_up', name: 'Follow-up Assessment', icon: 'ClockHistory', 
                  description: 'Review progress against a previous assessment. Checks implementation of remediation plans.' },
                { id: 'ad_hoc', name: 'Ad-Hoc Assessment', icon: 'AlertTriangle', 
                  description: 'A targeted review for a specific project, system, or immediate concern. Flexible scope.' }
            ];

            return e('div', { className: "p-8 bg-white rounded-xl shadow-lg border border-gray-200" },
                e('h2', { className: "text-2xl font-bold text-gray-700 mb-6" }, "Step 2: Select Assessment Type"),
                e('div', { className: "space-y-4" },
                    assessmentOptions.map(option => 
                        e('div', {
                            key: option.id,
                            onClick: () => setAssessmentType(option.id),
                            className: `
                                p-5 rounded-xl border-2 cursor-pointer transition duration-200
                                ${assessmentType === option.id 
                                    ? 'border-indigo-600 bg-indigo-50 shadow-md ring-4 ring-indigo-200' 
                                    : 'border-gray-200 hover:border-indigo-400 hover:bg-gray-50'
                                }
                            `
                        },
                            e('div', { className: "flex items-center space-x-4" },
                                e('span', {
                                    'data-lucide': option.icon,
                                    className: `w-8 h-8 ${assessmentType === option.id ? 'text-indigo-600' : 'text-gray-500'}`
                                }),
                                e('h3', { className: "text-xl font-bold text-gray-700" }, option.name)
                            ),
                            e('p', { className: "mt-3 text-gray-500 text-sm" }, option.description)
                        )
                    )
                ),
                e('div', { className: "flex justify-end pt-8" },
                    e('button', {
                        onClick: onNext,
                        disabled: !assessmentType,
                        className: `
                            px-6 py-2 text-white font-medium rounded-lg transition duration-150 flex items-center
                            ${assessmentType 
                                ? 'bg-indigo-600 hover:bg-indigo-700' 
                                : 'bg-gray-400 cursor-not-allowed'
                            }
                        `
                    },
                        "Continue to Step 3", // Correct button label
                        e('span', { 'data-lucide': "ArrowRight", className: "inline-block w-4 h-4 ml-2" })
                    )
                )
            );
        };

        // --- COMPONENT: Step2 (Persistence Mechanism - Step 3) ---
        const Step2 = ({ onNext, onPrevious, persistenceMechanism, setPersistenceMechanism }) => {
            useLucideIcons();

            const persistenceOptions = [
                { id: 'local_storage', name: 'Browser Local Storage', icon: 'HardDrive', 
                  description: 'Scores are saved directly in your browser. Fast, but data is lost if storage is cleared or browser changes.' },
                { id: 'server_database', name: 'Remote Server Database', icon: 'Cloud', 
                  description: 'Scores are saved on a server (requires setup). Secure and persistent across devices.' },
                { id: 'no_persistence', name: 'No Persistence (Session Only)', icon: 'ZapOff', 
                  description: 'No data is saved between sessions. Results are calculated instantly but lost on refresh.' }
            ];

            return e('div', { className: "p-8 bg-white rounded-xl shadow-lg border border-gray-200" },
                e('h2', { className: "text-2xl font-bold text-gray-700 mb-6" }, "Step 3: Choose Data Persistence"),
                
                e('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6" },
                    persistenceOptions.map(option => 
                        e('div', {
                            key: option.id,
                            onClick: () => setPersistenceMechanism(option.id),
                            className: `
                                p-5 rounded-xl border-2 cursor-pointer transition duration-200 h-full
                                ${persistenceMechanism === option.id 
                                    ? 'border-indigo-600 bg-indigo-50 shadow-md ring-4 ring-indigo-200' 
                                    : 'border-gray-200 hover:border-indigo-400 hover:bg-gray-50'
                                }
                            `
                        },
                            e('div', { className: "flex flex-col items-center text-center h-full" }, 
                                e('span', {
                                    'data-lucide': option.icon, 
                                    className: `w-8 h-8 mb-3 ${persistenceMechanism === option.id ? 'text-indigo-600' : 'text-gray-500'}`
                                }),
                                e('h3', { className: "text-xl font-bold text-gray-700" }, option.name),
                                e('p', { className: "mt-3 text-gray-500 text-sm flex-grow" }, option.description)
                            )
                        )
                    )
                ),

                e('div', { className: "flex justify-between pt-8 border-t mt-8" }, 
                    e('button', {
                        onClick: onPrevious,
                        className: "px-6 py-2 text-gray-600 bg-gray-200 hover:bg-gray-300 font-medium rounded-lg transition duration-150 flex items-center"
                    }, 
                        e('span', { 'data-lucide': "ArrowLeft", className: "inline-block w-4 h-4 mr-2" }),
                        "Back to Step 2"
                    ),
                    e('button', {
                        onClick: onNext,
                        disabled: !persistenceMechanism,
                        className: `
                            px-6 py-2 text-white font-medium rounded-lg transition duration-150 flex items-center
                            ${persistenceMechanism 
                                ? 'bg-indigo-600 hover:bg-indigo-700' 
                                : 'bg-gray-400 cursor-not-allowed'
                            }
                        `
                    }, 
                        "Continue to Step 4", 
                        e('span', { 'data-lucide': "ArrowRight", className: "inline-block w-4 h-4 ml-2" })
                    )
                )
            );
        };

        // --- COMPONENT: Step3 (Review/Ready - Step 4) ---
        const Step3 = ({ onStartAssessment, assessmentType, persistenceMechanism, onPrevious }) => {
            useLucideIcons();
            
            const getTypeLabel = (id) => {
                const options = {
                    'baseline': 'Baseline Assessment (High-Level)',
                    'follow_up': 'Follow-up Assessment (Remediation Check)',
                    'ad_hoc': 'Ad-Hoc Assessment (Targeted Review)'
                };
                return options[id] || id.toUpperCase();
            };

            const getPersistenceLabel = (id) => {
                const options = {
                    'local_storage': 'Browser Local Storage',
                    'server_database': 'Remote Server Database',
                    'no_persistence': 'No Persistence (Session Only)'
                };
                return options[id] || id.toUpperCase();
            };

            return e('div', { className: "p-8 bg-white rounded-xl shadow-lg border border-gray-200" },
                e('h2', { className: "text-3xl font-bold text-indigo-700 mb-6 flex items-center" }, 
                    e('span', { 'data-lucide': "CheckCircle", className: "inline-block w-6 h-6 mr-3" }),
                    "Step 4: Review and Start"
                ),

                e('div', { className: "space-y-4 p-6 bg-indigo-50 rounded-lg border border-indigo-200 mb-8" },
                    e('h3', { className: "text-xl font-semibold text-gray-700 border-b pb-2 mb-4" }, "Assessment Configuration Summary"),
                    e('div', { className: "flex justify-between py-2 border-b border-indigo-100" },
                        e('span', { className: "font-medium text-gray-600" }, "Assessment Type:"),
                        e('span', { className: "font-bold text-indigo-800" }, getTypeLabel(assessmentType))
                    ),
                    e('div', { className: "flex justify-between py-2" },
                        e('span', { className: "font-medium text-gray-600" }, "Data Persistence:"),
                        e('span', { className: "font-bold text-indigo-800" }, getPersistenceLabel(persistenceMechanism))
                    )
                ),

                e('div', { className: "text-center p-4 bg-yellow-50 rounded-lg border border-yellow-200" },
                    e('p', { className: "font-semibold text-yellow-800" }, "Click 'Start Assessment' to proceed to the questionnaire.")
                ),

                e('div', { className: "flex justify-between pt-8 border-t mt-8" }, 
                    e('button', {
                        onClick: onPrevious,
                        className: "px-6 py-2 text-gray-600 bg-gray-200 hover:bg-gray-300 font-medium rounded-lg transition duration-150 flex items-center"
                    }, 
                        e('span', { 'data-lucide': "ArrowLeft", className: "inline-block w-4 h-4 mr-2" }),
                        "Back to Step 3"
                    ),
                    e('button', {
                        onClick: onStartAssessment,
                        className: "px-8 py-3 text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg shadow-md transition duration-150 flex items-center"
                    }, 
                        "Start Assessment",
                        e('span', { 'data-lucide': "Play", className: "inline-block w-4 h-4 ml-2" })
                    )
                )
            );
        };

        // --- AssessmentView (THE MAIN SURVEY) ---
        const AssessmentView = ({ 
            assessmentType, 
            persistenceMechanism, 
            onEndAssessment, 
            ASSESSMENT_QUESTIONS, 
            answers, 
            setAnswers 
        }) => {
            useLucideIcons();
            
            // Format configuration details for display
            const displayType = assessmentType ? assessmentType.replace('_', ' ').toUpperCase() : 'N/A';
            const displayPersistence = persistenceMechanism ? persistenceMechanism.replace('_', ' ').toUpperCase() : 'N/A';

            // The possible score labels (0 to 4)
            const scoreLabels = [
                "0 (Not Implemented)", "1 (Initial)", "2 (Defined)", "3 (Managed)", "4 (Optimizing)"
            ];

            // Function to handle a rating selection
            const handleAnswer = (questionId, score) => {
                setAnswers(prevAnswers => ({
                    ...prevAnswers,
                    [questionId]: score
                }));
            };

            // Check if all questions have been answered (Answered count equals total questions)
            const totalQuestions = ASSESSMENT_QUESTIONS.length;
            const answeredCount = Object.keys(answers).filter(key => answers[key] !== undefined).length;
            const isComplete = answeredCount === totalQuestions;

            return e('div', { className: "space-y-6" },
                e('h2', { className: "text-3xl font-extrabold text-indigo-700 border-b-4 border-indigo-200 pb-2 mb-6" }, 
                    e('span', { 'data-lucide': "FlaskConical", className: "inline-block w-6 h-6 mr-3 align-text-bottom" }),
                    `Running IMSSS ${displayType} Assessment`
                ),
                
                // Progress display during assessment
                e('div', { className: "mb-8" },
                    e('div', { className: "text-center text-sm font-medium text-gray-700 mb-2" }, 
                        `Progress: ${answeredCount} / ${totalQuestions} Questions Answered`
                    ),
                    e('div', { className: "w-full bg-gray-200 rounded-full h-2.5" },
                        e('div', { 
                            className: "bg-green-500 h-2.5 rounded-full transition-all duration-500", 
                            style: { width: `${(answeredCount / totalQuestions) * 100}%` }
                        })
                    )
                ),

                e('div', { className: "p-4 bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 mb-6" },
                    e('p', { className: "font-semibold" }, "Configuration Notes:"),
                    e('ul', { className: "list-disc list-inside ml-4 text-sm" },
                        e('li', null, `Type: ${displayType}`),
                        e('li', null, `Data Persistence: ${displayPersistence}`)
                    )
                ),

                e('div', { className: "space-y-8 custom-scroll max-h-[60vh] overflow-y-auto p-2 -m-2" },
                    ASSESSMENT_QUESTIONS.map((q) => (
                        e('div', { key: q.id, className: "p-4 bg-white shadow rounded-lg border border-gray-200" },
                            e('p', { className: "font-semibold text-lg text-gray-800 mb-3" }, `Question ${q.id}: ${q.text}`),
                            
                            e('div', { className: "flex flex-wrap gap-3 text-sm" },
                                scoreLabels.map((label, score) => {
                                    const isSelected = answers[q.id] === score;
                                    return e('button', {
                                        key: score,
                                        onClick: () => handleAnswer(q.id, score),
                                        className: `
                                            px-4 py-2 rounded transition-colors duration-150
                                            ${isSelected
                                                ? 'bg-indigo-600 text-white font-bold shadow-md'
                                                : 'bg-gray-100 text-gray-700 hover:bg-indigo-100 hover:text-indigo-700'
                                            }
                                        `
                                    }, label);
                                })
                            )
                        )
                    ))
                ),
                
                e('div', { className: "flex justify-end pt-8 border-t mt-8" },
                    e('button', {
                        onClick: onEndAssessment,
                        disabled: !isComplete, 
                        className: `
                            px-6 py-2 text-white font-medium rounded-lg transition duration-150 flex items-center
                            ${isComplete
                                ? 'bg-green-600 hover:bg-green-700'
                                : 'bg-gray-400 cursor-not-allowed'
                            }
                        `
                    }, 
                        e('span', { 'data-lucide': "Trophy", className: "inline-block w-4 h-4 mr-2" }),
                        "Finish & View Results"
                    )
                )
            );
        };
        
        // --- ResultsView ---
        const ResultsView = ({ answers, ASSESSMENT_QUESTIONS, onStartNewAssessment }) => {
            useLucideIcons();
            
            const totalQuestions = ASSESSMENT_QUESTIONS.length;
            const totalScore = Object.values(answers).reduce((sum, score) => sum + score, 0);
            const maxScore = totalQuestions * 4; // Max score is 4 per question
            const averageScore = totalQuestions > 0 ? totalScore / totalQuestions : 0;
            const percentageScore = (totalScore / maxScore) * 100;
            
            const maturityLevel = getMaturityLevel(averageScore);

            const MaturityIndicator = e('div', { className: `p-6 rounded-xl text-center ${maturityLevel.bg} border-4 border-dashed border-gray-300` },
                e('p', { className: "text-2xl font-semibold text-gray-700" }, "Your Current Maturity Level is:"),
                e('h3', { className: `text-5xl font-extrabold ${maturityLevel.color} mt-2` }, maturityLevel.name),
                e('p', { className: "mt-4 text-gray-600" }, `Based on an average score of **${averageScore.toFixed(2)}** out of 4.0.`)
            );

            return e('div', { className: "space-y-8 p-8 bg-white rounded-xl shadow-2xl border-t-8 border-indigo-600" },
                e('h2', { className: "text-3xl font-bold text-indigo-700 flex items-center border-b pb-4" },
                    e('span', { 'data-lucide': "Trophy", className: "inline-block w-8 h-8 mr-3" }),
                    "IMSSS Assessment Results"
                ),

                MaturityIndicator,
                
                e('div', { className: "grid grid-cols-2 gap-4 text-center" },
                    e('div', { className: "p-4 bg-gray-50 rounded-lg shadow-inner" },
                        e('p', { className: "text-sm text-gray-500" }, "Total Score Achieved"),
                        e('p', { className: "text-3xl font-bold text-indigo-600 mt-1" }, `${totalScore} / ${maxScore}`)
                    ),
                    e('div', { className: "p-4 bg-gray-50 rounded-lg shadow-inner" },
                        e('p', { className: "text-sm text-gray-500" }, "Overall Percentage"),
                        e('p', { className: "text-3xl font-bold text-indigo-600 mt-1" }, `${percentageScore.toFixed(1)}%`)
                    )
                ),

                e('div', { className: "mt-6" },
                    e('h3', { className: "text-xl font-semibold text-gray-700 mb-3" }, "Detailed Scoring (Maturity Levels)"),
                    e('p', { className: "text-sm text-gray-500 mb-4" }, "The score breakdown shows how your answers contribute to the final maturity level:"),
                    e('div', { className: "text-sm text-gray-800 space-y-2 p-4 border rounded-lg bg-white shadow-sm" },
                        ASSESSMENT_QUESTIONS.map((q) => {
                            // Ensure score is defined, default to 0
                            const score = answers[q.id] !== undefined ? answers[q.id] : 0; 
                            return e('div', { key: q.id, className: "flex justify-between items-center py-1 border-b last:border-b-0" },
                                e('span', { className: "truncate w-3/4" }, `Q${q.id}: ${q.text}`),
                                e('span', { className: "font-bold text-indigo-600" }, `${score} / ${q.maxScore}`)
                            );
                        })
                    )
                ),

                e('div', { className: "flex justify-center pt-6 border-t" },
                    e('button', {
                        onClick: onStartNewAssessment,
                        className: "px-8 py-3 text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg shadow-md transition duration-150 flex items-center"
                    }, 
                        e('span', { 'data-lucide': "RefreshCw", className: "inline-block w-4 h-4 mr-2" }),
                        "Start New Assessment"
                    )
                )
            );
        };
        
        // --- IMSSS CONTAINER COMPONENT (MAIN APPLICATION LOGIC) ---
        const AssessorContainer = () => {
            // 1. LOCAL STORAGE KEY
            const STORAGE_KEY = 'imsss_setup_data';

            // --- ASSESSMENT DATA ---
            const ASSESSMENT_QUESTIONS = useMemo(() => ([
                { id: 1, text: "Do you have a documented Information Security Policy?", maxScore: 4 },
                { id: 2, text: "Is multifactor authentication enforced for privileged accounts?", maxScore: 4 },
                { id: 3, text: "How often are vulnerability scans performed?", maxScore: 4 },
                { id: 4, text: "Are backups performed regularly and tested for recovery?", maxScore: 4 },
                { id: 5, text: "Is security awareness training mandatory for all employees?", maxScore: 4 },
            ]), []);
            // -----------------------------

            // State for the application flow
            const [step, setStep] = useState(1);
            const [assessmentType, setAssessmentType] = useState(null);
            const [persistenceMechanism, setPersistenceMechanism] = useState(null);
            const [isAssessmentStarted, setIsAssessmentStarted] = useState(false);
            const [isAssessmentFinished, setIsAssessmentFinished] = useState(false); 
            const [answers, setAnswers] = useState({});


            // --- Data Loading Effect (Runs on initial mount) ---
            useEffect(() => {
                try {
                    const storedData = localStorage.getItem(STORAGE_KEY);
                    if (storedData) {
                        const data = JSON.parse(storedData);
                        
                        if (data.persistenceMechanism) {
                            setPersistenceMechanism(data.persistenceMechanism);
                        }
                        if (data.assessmentType) {
                            setAssessmentType(data.assessmentType);
                        }
                        if (data.answers) {
                            setAnswers(data.answers);
                        }
                        
                        // If setup data was found, start at step 2, assuming Step 1 (ToS) was accepted
                        if ((data.persistenceMechanism || data.assessmentType) && !isAssessmentStarted && !isAssessmentFinished) {
                            setStep(2); 
                            console.log("Loaded setup data from Local Storage. Skipping initial ToS step.");
                        }
                    }
                } catch (error) {
                    console.error("Error loading state from Local Storage:", error);
                }
            }, []); 

            // --- Data Saving Effect (Runs when choices or answers change) ---
            useEffect(() => {
                // Only save if a persistence method is selected AND it is local storage
                if (persistenceMechanism === 'local_storage') {
                    try {
                        const dataToStore = JSON.stringify({
                            assessmentType,
                            persistenceMechanism,
                            answers 
                        });
                        localStorage.setItem(STORAGE_KEY, dataToStore);
                        // console.log("Saved state to Local Storage.");
                    } catch (error) {
                        console.error("Error saving state to Local Storage:", error);
                    }
                }
                // Clear local storage if a non-local storage persistence method is chosen
                else if (persistenceMechanism && persistenceMechanism !== 'local_storage') {
                    localStorage.removeItem(STORAGE_KEY);
                    // console.log("Cleared Local Storage data.");
                }
            }, [assessmentType, persistenceMechanism, answers]); 

            // Function to navigate between steps
            const nextStep = () => setStep(prev => prev + 1);
            const previousStep = () => setStep(prev => prev - 1);
            
            // Function to handle breadcrumb clicks (must not exceed current step)
            const handleBreadcrumbClick = (targetStep) => {
                // Allows navigation backward only if the target step has been completed
                if (targetStep < step && targetStep >= 1) {
                    setStep(targetStep);
                }
            };
            
            // Assessment phase functions
            const startAssessment = () => {
                setIsAssessmentStarted(true);
                setIsAssessmentFinished(false); 
                // Set step high so the setup breadcrumb hides, letting the banner appear
                setStep(5); 
            }

            const endAssessment = () => {
                setIsAssessmentStarted(false); 
                setIsAssessmentFinished(true); // Switch to Results View
                setStep(6); // Set step high for results state
                // console.log("Assessment Ended. Showing results.");
            };
            
            const startNewAssessment = () => {
                // Completely reset the application state
                setAssessmentType(null);
                setPersistenceMechanism(null);
                setAnswers({}); 
                localStorage.removeItem(STORAGE_KEY);
                setIsAssessmentStarted(false);
                setIsAssessmentFinished(false);
                setStep(1); 
                // console.log("Starting new assessment, state reset.");
            }

            const renderStep = () => {
                // 1. If finished, show results
                if (isAssessmentFinished) {
                    return e(ResultsView, {
                        answers: answers,
                        ASSESSMENT_QUESTIONS: ASSESSMENT_QUESTIONS,
                        onStartNewAssessment: startNewAssessment
                    });
                }
                
                // 2. If started, show assessment
                if (isAssessmentStarted) {
                    return e(AssessmentView, {
                        assessmentType: assessmentType,
                        persistenceMechanism: persistenceMechanism,
                        onEndAssessment: endAssessment,
                        ASSESSMENT_QUESTIONS: ASSESSMENT_QUESTIONS,         
                        answers: answers,                   
                        setAnswers: setAnswers,             
                    });
                }
                
                // 3. Otherwise, show setup steps (Step 1 to 4)
                switch (step) {
                    case 1:
                        return e(TermsOfService, { 
                            onAccept: nextStep,
                        });
                    case 2:
                        return e(Step1, { 
                            onNext: nextStep,
                            assessmentType: assessmentType,
                            setAssessmentType: setAssessmentType,
                        });
                    case 3:
                        return e(Step2, { 
                            onNext: nextStep,
                            onPrevious: previousStep,
                            persistenceMechanism: persistenceMechanism,
                            setPersistenceMechanism: setPersistenceMechanism,
                        });
                    case 4: // This is the final Review step before starting the Assessment
                        return e(Step3, { 
                            onStartAssessment: startAssessment,
                            onPrevious: previousStep,
                            assessmentType: assessmentType,
                            persistenceMechanism: persistenceMechanism,
                        });
                    default:
                        // Default case should only be reached if step is > 4 without isAssessmentStarted/isAssessmentFinished flags set
                        return e('div', { className: "text-center p-12 bg-red-100 rounded-xl shadow-lg text-red-700 font-bold" },
                            "Error: Unknown Setup Step or Step index out of range."
                        );
                }
            };

            return e('div', { className: "max-w-4xl w-full mx-auto" },
                e('header', { className: "text-center mb-6" },
                    e('h1', { className: "text-4xl font-extrabold text-gray-800" }, "IMSSS Assessor Setup Wizard"),
                    e('p', { className: "text-gray-500 mt-2" }, "Internal Maturity Self-Scoring System")
                ),
                
                e(Breadcrumb, { 
                    currentStep: step, 
                    onStepClick: handleBreadcrumbClick, 
                    isAssessmentStarted: isAssessmentStarted,
                    isAssessmentFinished: isAssessmentFinished
                }),
                
                e('main', { className: "bg-white p-6 rounded-2xl shadow-2xl" },
                    renderStep()
                )
            );
        };

        // Render the main component
        ReactDOM.render(
            e(AssessorContainer),
            document.getElementById('root')
        );
    </script>
</body>
</html>
