<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMSSS Assessor Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #a5b4fc; /* indigo-300 */
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #e0e7ff; /* indigo-100 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex items-center justify-center">
    <div id="root" class="w-full"></div>

    <script>
        // Aliases for React functions
        const { useState, useEffect, useMemo } = React;
        const e = React.createElement;

        // --- GLOBAL UTILITY: Lucide Icons Rendering ---
        const useLucideIcons = () => {
            useEffect(() => {
                lucide.createIcons();
            }, []);
        };
        
        // --- COMPONENT: Breadcrumb (Step Indicator) ---
        const Breadcrumb = ({ currentStep, onStepClick, isAssessmentStarted }) => {
            useLucideIcons();
            
            const steps = [
                { id: 1, name: "Start", icon: "Rocket" },
                { id: 2, name: "Type", icon: "LayoutGrid" },
                { id: 3, name: "Storage", icon: "Database" },
                { id: 4, name: "Review", icon: "CheckCircle" },
                { id: 5, name: "Assessment", icon: "FlaskConical" } // Placeholder for assessment phase
            ];
            
            if (isAssessmentStarted) {
                return e('div', { className: "text-center text-lg font-bold text-green-600 mb-8 p-3 bg-green-50 rounded-lg shadow-inner" },
                    e('span', { 'data-lucide': "FlaskConical", className: "inline-block w-5 h-5 mr-2 align-text-bottom" }),
                    "Assessment In Progress"
                );
            }
            
            return e('nav', { className: "flex items-center justify-center space-x-2 mb-8" },
                steps.slice(0, 4).map((stepItem) => {
                    const isActive = stepItem.id === currentStep;
                    const isCompleted = stepItem.id < currentStep;
                    
                    const classes = `
                        flex flex-col items-center p-3 rounded-xl transition duration-300 w-1/4
                        ${isActive 
                            ? 'bg-indigo-600 shadow-lg text-white font-bold transform scale-105' 
                            : isCompleted 
                                ? 'bg-indigo-100 text-indigo-700 cursor-pointer hover:bg-indigo-200' 
                                : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                        }
                    `;
                    
                    return e('div', { 
                        key: stepItem.id,
                        onClick: isCompleted ? () => onStepClick(stepItem.id) : null,
                        className: classes
                    },
                        e('span', { 'data-lucide': isCompleted ? "Check" : stepItem.icon, className: "w-6 h-6 mb-1" }),
                        e('span', { className: "text-xs font-medium" }, `Step ${stepItem.id}: ${stepItem.name}`)
                    );
                })
            );
        };

        // --- COMPONENT: TermsOfService (Step 1) ---
        const TermsOfService = ({ onAccept }) => {
            useLucideIcons();
            
            return e('div', { className: "p-8 bg-white rounded-xl shadow-lg border border-gray-200" },
                e('h2', { className: "text-3xl font-bold text-indigo-700 mb-4 flex items-center" }, 
                    e('span', { 'data-lucide': "FileText", className: "inline-block w-6 h-6 mr-3" }),
                    "Step 1: Terms of Service" // Updated title to match flow
                ),
                e('div', { className: "h-64 overflow-y-auto p-4 bg-gray-50 border rounded-lg text-sm text-gray-600 leading-relaxed" },
                    e('p', { className: "mb-3 font-semibold" }, "Welcome to the IMSSS Assessor."),
                    e('p', { className: "mb-3" }, "This tool is designed to help you perform a preliminary assessment based on security maturity levels. By accepting these terms, you acknowledge the following:"),
                    e('ul', { className: "list-disc list-inside ml-4 space-y-2" },
                        e('li', null, "The results are for **informational purposes only** and do not constitute a certified security audit."),
                        e('li', null, "The data collected will be stored based on your chosen persistence mechanism (e.g., Local Storage or Server)."),
                        e('li', null, "You are responsible for the accuracy of the information provided during the assessment."),
                        e('li', null, "The assessment framework is based on the **IMSSS** (Internal Maturity Self-Scoring System) model."),
                    ),
                    e('p', { className: "mt-4 font-semibold text-red-600" }, "Do not use this tool with highly sensitive or confidential information unless you are fully aware of and accept the risks associated with the selected persistence method."),
                ),
                e('div', { className: "flex justify-end mt-6" },
                    e('button', {
                        onClick: onAccept,
                        className: "px-8 py-3 text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg shadow-md transition duration-150 flex items-center"
                    }, 
                        "Accept and Continue",
                        e('span', { 'data-lucide': "ArrowRight", className: "inline-block w-4 h-4 ml-2" })
                    )
                )
            );
        };

        // --- COMPONENT: Step1 (Assessment Type - Now Step 2) ---
        const Step1 = ({ onNext, assessmentType, setAssessmentType }) => {
            useLucideIcons();
            
            const assessmentOptions = [
                { id: 'baseline', name: 'Baseline Assessment', icon: 'HardHat', 
                  description: 'A quick, high-level review of foundational security controls. Focuses on critical gaps.' },
                { id: 'comprehensive', name: 'Comprehensive Audit', icon: 'Microscope', 
                  description: 'A deep dive into technical and procedural controls. Provides a granular maturity score.' },
                { id: 'compliance_check', name: 'Compliance Check (ISO/NIST)', icon: 'Scale', 
                  description: 'Measures readiness against common regulatory or industry standards.' }
            ];

            return e('div', { className: "p-8 bg-white rounded-xl shadow-lg border border-gray-200" },
                e('h2', { className: "text-2xl font-bold text-gray-700 mb-6" }, "Step 2: Select Assessment Type"), // Corrected title
                e('div', { className: "space-y-4" },
                    assessmentOptions.map(option => 
                        e('div', {
                            key: option.id,
                            onClick: () => setAssessmentType(option.id),
                            className: `
                                p-5 rounded-xl border-2 cursor-pointer transition duration-200
                                ${assessmentType === option.id 
                                    ? 'border-indigo-600 bg-indigo-50 shadow-md ring-4 ring-indigo-200' 
                                    : 'border-gray-200 hover:border-indigo-400 hover:bg-gray-50'
                                }
                            `
                        },
                            e('div', { className: "flex items-center space-x-4" },
                                e('span', {
                                    'data-lucide': option.icon,
                                    className: `w-8 h-8 ${assessmentType === option.id ? 'text-indigo-600' : 'text-gray-500'}`
                                }),
                                e('h3', { className: "text-xl font-bold text-gray-700" }, option.name)
                            ),
                            e('p', { className: "mt-3 text-gray-500 text-sm" }, option.description)
                        )
                    )
                ),
                e('div', { className: "flex justify-end pt-8" },
                    e('button', {
                        onClick: onNext,
                        disabled: !assessmentType,
                        className: `
                            px-6 py-2 text-white font-medium rounded-lg transition duration-150 flex items-center
                            ${assessmentType 
                                ? 'bg-indigo-600 hover:bg-indigo-700' 
                                : 'bg-gray-400 cursor-not-allowed'
                            }
                        `
                    },
                        "Continue to Step 3", // Updated button text
                        e('span', { 'data-lucide': "ArrowRight", className: "inline-block w-4 h-4 ml-2" })
                    )
                )
            );
        };

        // --- UPDATED COMPONENT: Step2 (Persistence Mechanism - Now Step 3) ---
        const Step2 = ({ onNext, onPrevious, persistenceMechanism, setPersistenceMechanism }) => {
            useLucideIcons();

            const persistenceOptions = [
                { id: 'local_storage', name: 'Browser Local Storage', icon: 'HardDrive', 
                  description: 'Scores are saved directly in your browser. Fast, but data is lost if storage is cleared or browser changes.' },
                { id: 'server_database', name: 'Remote Server Database', icon: 'Cloud', 
                  description: 'Scores are saved on a server (requires setup). Secure and persistent across devices.' },
                { id: 'no_persistence', name: 'No Persistence (Session Only)', icon: 'ZapOff', 
                  description: 'No data is saved between sessions. Results are calculated instantly but lost on refresh.' }
            ];

            return e('div', { className: "p-8 bg-white rounded-xl shadow-lg border border-gray-200" },
                e('h2', { className: "text-2xl font-bold text-gray-700 mb-6" }, "Step 3: Choose Data Persistence"), // Corrected title
                
                // *** New Grid Layout for Options ***
                e('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6" },
                    persistenceOptions.map(option => 
                        e('div', {
                            key: option.id,
                            onClick: () => setPersistenceMechanism(option.id),
                            className: `
                                p-5 rounded-xl border-2 cursor-pointer transition duration-200 h-full
                                ${persistenceMechanism === option.id 
                                    ? 'border-indigo-600 bg-indigo-50 shadow-md ring-4 ring-indigo-200' 
                                    : 'border-gray-200 hover:border-indigo-400 hover:bg-gray-50'
                                }
                            `
                        },
                            e('div', { className: "flex flex-col items-center text-center h-full" }, 
                                // Icon styling from your suggestion
                                e('span', {
                                    'data-lucide': option.icon, 
                                    className: `w-8 h-8 mb-3 ${persistenceMechanism === option.id ? 'text-indigo-600' : 'text-gray-500'}`
                                }),
                                // Title styling from your suggestion
                                e('h3', { className: "text-xl font-bold text-gray-700" }, option.name),
                                // Description styling
                                e('p', { className: "mt-3 text-gray-500 text-sm flex-grow" }, option.description)
                            )
                        )
                    )
                ),

                // Navigation Buttons
                e('div', { className: "flex justify-between pt-8 border-t mt-8" }, 
                    e('button', {
                        onClick: onPrevious,
                        className: "px-6 py-2 text-gray-600 bg-gray-200 hover:bg-gray-300 font-medium rounded-lg transition duration-150 flex items-center"
                    }, 
                        e('span', { 'data-lucide': "ArrowLeft", className: "inline-block w-4 h-4 mr-2" }),
                        "Back to Step 2"
                    ),
                    e('button', {
                        onClick: onNext,
                        disabled: !persistenceMechanism,
                        className: `
                            px-6 py-2 text-white font-medium rounded-lg transition duration-150 flex items-center
                            ${persistenceMechanism 
                                ? 'bg-indigo-600 hover:bg-indigo-700' 
                                : 'bg-gray-400 cursor-not-allowed'
                            }
                        `
                    }, 
                        "Complete Setup",
                        e('span', { 'data-lucide': "Check", className: "inline-block w-4 h-4 ml-2" })
                    )
                )
            );
        };


        // --- AssessmentView (THE MAIN SURVEY) ---
        const AssessmentView = ({ 
            assessmentType, 
            persistenceMechanism, 
            onEndAssessment, 
            ASSESSMENT_QUESTIONS, 
            answers,             
            setAnswers           
        }) => {
            useLucideIcons();
            
            // Format configuration details for display
            const displayType = assessmentType.replace('_', ' ').toUpperCase();
            const displayPersistence = persistenceMechanism.replace('_', ' ').toUpperCase();

            // The possible score labels (0 to 4)
            const scoreLabels = [
                "0 (Not Implemented)", "1 (Initial)", "2 (Defined)", "3 (Managed)", "4 (Optimizing)"
            ];

            // Function to handle a rating selection
            const handleAnswer = (questionId, score) => {
                setAnswers(prevAnswers => ({
                    ...prevAnswers,
                    [questionId]: score
                }));
            };

            // Check if all questions have been answered (Answered count equals total questions)
            const totalQuestions = ASSESSMENT_QUESTIONS.length;
            const answeredCount = Object.keys(answers).length;
            const isComplete = answeredCount === totalQuestions;

            return e('div', { className: "space-y-6" },
                e('h2', { className: "text-3xl font-extrabold text-indigo-700 border-b-4 border-indigo-200 pb-2 mb-6" }, 
                    e('span', { 'data-lucide': "FlaskConical", className: "inline-block w-6 h-6 mr-3 align-text-bottom" }),
                    `Running IMSSS ${displayType} Assessment`
                ),
                
                // Progress display during assessment
                e('div', { className: "mb-8" },
                    e('div', { className: "text-center text-sm font-medium text-gray-700 mb-2" }, 
                        `Progress: ${answeredCount} / ${totalQuestions} Questions Answered`
                    ),
                    e('div', { className: "w-full bg-gray-200 rounded-full h-2.5" },
                        e('div', { 
                            className: "bg-green-500 h-2.5 rounded-full transition-all duration-500", 
                            style: { width: `${(answeredCount / totalQuestions) * 100}%` }
                        })
                    )
                ),

                e('div', { className: "p-4 bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 mb-6" },
                    e('p', { className: "font-semibold" }, "Configuration Notes:"),
                    e('ul', { className: "list-disc list-inside ml-4 text-sm" },
                        e('li', null, `Type: ${displayType}`),
                        e('li', null, `Data Persistence: ${displayPersistence}`)
                    )
                ),

                e('div', { className: "space-y-8" },
                    ASSESSMENT_QUESTIONS.map((q) => (
                        e('div', { key: q.id, className: "p-4 bg-white shadow rounded-lg border border-gray-200" },
                            e('p', { className: "font-semibold text-lg text-gray-800 mb-3" }, `Question ${q.id}: ${q.text}`),
                            
                            e('div', { className: "flex flex-wrap gap-3 text-sm" },
                                scoreLabels.map((label, score) => {
                                    const isSelected = answers[q.id] === score;
                                    return e('button', {
                                        key: score,
                                        onClick: () => handleAnswer(q.id, score),
                                        className: `
                                            px-4 py-2 rounded transition-colors duration-150
                                            ${isSelected
                                                ? 'bg-indigo-600 text-white font-bold shadow-md'
                                                : 'bg-gray-100 text-gray-700 hover:bg-indigo-100 hover:text-indigo-700'
                                            }
                                        `
                                    }, label);
                                })
                            )
                        )
                    ))
                ),
                
                e('div', { className: "flex justify-end pt-8 border-t" },
                    e('button', {
                        onClick: onEndAssessment,
                        disabled: !isComplete, 
                        className: `
                            px-6 py-2 text-white font-medium rounded-lg transition duration-150 flex items-center
                            ${isComplete
                                ? 'bg-green-600 hover:bg-green-700'
                                : 'bg-gray-400 cursor-not-allowed'
                            }
                        `
                    }, 
                        e('span', { 'data-lucide': "Trophy", className: "inline-block w-4 h-4 mr-2" }),
                        "Finish & View Results"
                    )
                )
            );
        };


        // --- IMSSS CONTAINER COMPONENT (MAIN APPLICATION LOGIC) ---
        const AssessorContainer = () => {
            // 1. LOCAL STORAGE KEY
            const STORAGE_KEY = 'imsss_setup_data';

            // --- ASSESSMENT DATA ---
            const ASSESSMENT_QUESTIONS = useMemo(() => ([
                { id: 1, text: "Do you have a documented Information Security Policy?", maxScore: 4 },
                { id: 2, text: "Is multifactor authentication enforced for privileged accounts?", maxScore: 4 },
                { id: 3, text: "How often are vulnerability scans performed?", maxScore: 4 },
                { id: 4, text: "Are backups performed regularly and tested for recovery?", maxScore: 4 },
                { id: 5, text: "Is security awareness training mandatory for all employees?", maxScore: 4 },
            ]), []);
            // -----------------------------

            // State for the application flow
            const [step, setStep] = useState(1);
            const [assessmentType, setAssessmentType] = useState(null);
            const [persistenceMechanism, setPersistenceMechanism] = useState(null);
            const [isAssessmentStarted, setIsAssessmentStarted] = useState(false);
            const [answers, setAnswers] = useState({});


            // --- Data Loading Effect (Runs on initial mount) ---
            useEffect(() => {
                try {
                    const storedData = localStorage.getItem(STORAGE_KEY);
                    if (storedData) {
                        const data = JSON.parse(storedData);
                        
                        if (data.persistenceMechanism) {
                            setPersistenceMechanism(data.persistenceMechanism);
                        }
                        if (data.assessmentType) {
                            setAssessmentType(data.assessmentType);
                        }
                        // Load answers if they exist
                        if (data.answers) {
                            setAnswers(data.answers);
                        }
                        
                        // If any data was found, skip the ToS and jump to Step 2
                        if ((data.persistenceMechanism || data.assessmentType) && !isAssessmentStarted) {
                            setStep(2); 
                            console.log("Loaded setup data from Local Storage. Skipping initial steps.");
                        }
                    }
                } catch (error) {
                    console.error("Error loading state from Local Storage:", error);
                }
            }, []); // Runs once on mount

            // --- Data Saving Effect (Runs when choices or answers change) ---
            useEffect(() => {
                if (persistenceMechanism === 'local_storage') {
                    try {
                        const dataToStore = JSON.stringify({
                            assessmentType,
                            persistenceMechanism,
                            answers 
                        });
                        localStorage.setItem(STORAGE_KEY, dataToStore);
                        console.log("Saved state to Local Storage.");
                    } catch (error) {
                        console.error("Error saving state to Local Storage:", error);
                    }
                }
                // If the mechanism is NOT local storage, clear old local storage data to be safe
                else if (persistenceMechanism && persistenceMechanism !== 'local_storage') {
                    localStorage.removeItem(STORAGE_KEY);
                    console.log("Cleared Local Storage data.");
                }
            }, [assessmentType, persistenceMechanism, answers]); // Runs whenever these states change

            // Function to navigate between steps
            const nextStep = () => setStep(prev => prev + 1);
            const previousStep = () => setStep(prev => prev - 1);
            
            // Function to handle breadcrumb clicks (must not exceed current step)
            const handleBreadcrumbClick = (targetStep) => {
                if (targetStep < step && targetStep >= 1) {
                    setStep(targetStep);
                }
            };
            
            // New assessment phase functions
            const startAssessment = () => setIsAssessmentStarted(true);
            const endAssessment = () => {
                setIsAssessmentStarted(false); 
                // Reset state for a new setup
                setAssessmentType(null);
                setPersistenceMechanism(null);
                setAnswers({}); 
                localStorage.removeItem(STORAGE_KEY);
                alert("Assessment Finished! Resetting setup for a new assessment.");
                setStep(1); 
            };

            const renderStep = () => {
                // NEW: If the assessment has started, render the AssessmentView regardless of step number
                if (isAssessmentStarted) {
                    return e(AssessmentView, {
                        assessmentType: assessmentType,
                        persistenceMechanism: persistenceMechanism,
                        onEndAssessment: endAssessment,
                        ASSESSMENT_QUESTIONS: ASSESSMENT_QUESTIONS, 
                        answers: answers,                         
                        setAnswers: setAnswers,                   
                    });
                }
                
                switch (step) {
                    case 1:
                        return e(TermsOfService, { // STEP 1: ToS
                            onAccept: nextStep,
                        });
                    case 2:
                        return e(Step1, { // STEP 2: Assessment Type
                            onNext: nextStep,
                            assessmentType: assessmentType,
                            setAssessmentType: setAssessmentType,
                        });
                    case 3:
                        return e(Step2, { // STEP 3: Persistence Mechanism
                            onNext: nextStep,
                            onPrevious: previousStep,
                            persistenceMechanism: persistenceMechanism,
                            setPersistenceMechanism: setPersistenceMechanism,
                        });
                    case 4: // STEP 4: Final Summary 
                        return e('div', { className: "text-center p-12 bg-green-50 rounded-xl shadow-lg" },
                            useLucideIcons(), 
                            e('span', { 'data-lucide': "Award", className: "w-16 h-16 text-green-600 mx-auto block mb-4" }),
                            e('h2', { className: "text-3xl font-bold text-green-800" }, "Setup Complete!"),
                            e('p', { className: "mt-2 text-lg text-green-700" }, "IMSSS Assessor is now configured with:"),
                            e('ul', { className: "mt-4 space-y-2 text-left inline-block" },
                                e('li', { className: "text-gray-700 font-medium" }, 
                                    "Assessment Type: ", 
                                    e('span', { className: "text-indigo-600 capitalize" }, assessmentType.replace('_', ' '))
                                ),
                                e('li', { className: "text-gray-700 font-medium" }, 
                                    "Persistence Method: ", 
                                    e('span', { className: "text-indigo-600 capitalize" }, persistenceMechanism.replace('_', ' '))
                                )
                            ),
                            e('div', { className: "mt-8 flex justify-center space-x-4" },
                                e('button', {
                                    onClick: startAssessment, 
                                    className: "px-6 py-2 text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg transition duration-150 flex items-center"
                                }, 
                                    e('span', { 'data-lucide': "Zap", className: "inline-block w-4 h-4 mr-2" }),
                                    "Start Assessment"
                                ),
                                e('button', {
                                    onClick: () => setStep(1),
                                    className: "px-6 py-2 text-gray-600 bg-gray-200 hover:bg-gray-300 font-medium rounded-lg transition duration-150"
                                }, "Start Over")
                            )
                        );
                    default:
                        // Fallback: If step is out of bounds, return to step 1 (Terms of Service)
                        return e(TermsOfService, { onAccept: nextStep });
                }
            };

            // Progress Bar Logic
            const progressSteps = 4;
            
            return e('div', { className: "max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-2xl shadow-2xl custom-scroll" },
                e('h1', { className: "text-3xl font-extrabold text-indigo-700 mb-6 border-b-4 border-indigo-200 pb-2" }, "IMSSS Assessor Setup Wizard"),
                
                // Breadcrumb Component
                e(Breadcrumb, { 
                    currentStep: step, 
                    onStepClick: handleBreadcrumbClick,
                    isAssessmentStarted: isAssessmentStarted
                }),

                // Progress Bar (Only visible during setup steps 1-4)
                !isAssessmentStarted && e('div', { className: "mb-8" },
                    e('div', { className: "flex justify-between text-sm font-medium text-gray-500 mb-2" },
                        e('span', null, `Step ${step} of 4`),
                        e('span', { className: "text-indigo-600" }, step === 4 ? 'Ready to Start' : 'Setup in Progress')
                    ),
                    e('div', { className: "w-full bg-gray-200 rounded-full h-2.5" },
                        e('div', { 
                            className: "bg-indigo-600 h-2.5 rounded-full transition-all duration-500", 
                            style: { width: `${(step / 4) * 100}%` }
                        })
                    )
                ),
                
                renderStep()
            );
        };

        // --- MAIN APP COMPONENT ---
        const MainApp = () => {
            return e('div', { className: "h-full w-full" }, e(AssessorContainer));
        };
        
        // --- MANUAL MOUNT (No Babel needed) ---
        document.addEventListener('DOMContentLoaded', function() {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                ReactDOM.createRoot(rootElement).render(e(MainApp));
                console.log("IMSSS App successfully rendered using pure JavaScript!");
            } else {
                console.error("Root element not found.");
            }
        });
    </script>
</body>
</html>
