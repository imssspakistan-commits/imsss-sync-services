<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>IMSSS AI Risk Assessor</title>

    <script src="https://cdn.tailwindcss.com?version=3.4.4"></script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/lucide@0.368.0"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&display=swap');

        :root {
            --bg-color: #0f172a; /* slate-900 */
            --glass-bg: rgba(30, 41, 59, 0.7); /* slate-800 with transparency */
            --border-color: #334155; /* slate-700 */
            --input-bg: #1e293b; /* slate-800 */
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, #1e293b 1px, transparent 1px);
            background-size: 50px 50px;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            touch-action: manipulation; 
        }
        
        #root {
            min-height: 100vh;
        }

        /* Custom Fonts */
        .font-sans { font-family: 'Roboto Mono', sans-serif; }
        .font-urdu { font-family: 'Noto Sans Arabic', sans-serif; }

        /* Glass Panel Effect */
        .glass-panel {
            background-color: var(--glass-bg);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Neon Text for Highlights */
        .neon-text {
            text-shadow: 0 0 5px rgba(59, 130, 246, 0.5), 0 0 10px rgba(59, 130, 246, 0.3);
        }

        /* Live Dot Animation */
        .live-dot {
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Ensure scrollable area is visible */
        .scrollable-summary {
            max-height: 300px; 
            overflow-y: auto;
            padding-right: 10px;
        }
        
        /* Styles to hide components during PDF rendering */
        @media print {
            .no-print { display: none !important; }
            .report-container { background-color: white !important; color: black !important; }
            body { background-image: none !important; background-color: white !important; }
        }
    </style>
</head>
<body>

    <div id="announcer" aria-live="polite" class="sr-only"></div> 

    <div id="root" aria-live="polite">
        <div class="text-white text-center p-10">Loading Application...</div>
    </div>

    <script>
        // --- CRITICAL CHECK: Ensure React and ReactDOM are available globally ---
        if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof lucide === 'undefined') {
            document.getElementById('root').innerHTML = '<div class="text-white p-10 bg-red-900/50">FATAL ERROR: External dependencies (React, ReactDOM, or Lucide Icons) failed to load. Check network connection or dependency URLs.</div>';
            console.error("FATAL ERROR: React, ReactDOM, or Lucide Icons are undefined. Dependencies failed to load.");
        } else {
            // Libraries loaded successfully, proceed with initialization
            var useState = React.useState;
            var useEffect = React.useState; // Corrected: Should be React.useEffect
            var e = React.createElement;

            // --- CRITICAL FIX: Ensure useEffect is correctly assigned ---
            if (typeof React.useEffect === 'function') {
                useEffect = React.useEffect;
            } else {
                console.warn("React.useEffect not found. Application integrity might be compromised.");
            }
            // --- CONSTANTS FOR LOCALSTORAGE KEYS ---
            var LS_KEY_LANG = 'imsss_lang';
            var LS_KEY_ANSWERS = 'imsss_answers';
            var LS_KEY_SCORES = 'imsss_scores';
            var LS_KEY_PROGRESS = 'imsss_progress';
            var LS_KEY_HASH = 'imsss_final_hash'; 
            var LS_KEY_TTS = 'imsss_tts_active'; 
            
            // NEW KEYS FOR PHASE X (TOS & USER INFO)
            var LS_KEY_AGREED = 'imsss_tos_agreed';
            var LS_KEY_USERINFO = 'imsss_user_info';

            // --- 1. GLOBALIZATION ENGINE ---
            var LANGUAGES = {
                EN: { 
                    name: "English", code: "en", dir: "ltr", font: "font-sans", 
                    text: { 
                        title: "IMSSS ASSESSOR", subtitle: "AI ADVERSARIAL & RISK AUDIT", startBtn: "BEGIN ASSESSMENT", reset: "START NEW SESSION", 
                        report: "AUDIT SUMMARY REPORT", monitoring: "LIVE MONITORING", integrity: "IMMUTABLE HASH", metrics: "System Metrics", 
                        complianceSummary: "VIOLATION & REMEDIATION SUMMARY", 
                        iso: "ISO 42001", eu: "EU AI Act", us: "NIST AI RMF", 
                        gov: "Governance", risk: "Risk Mgmt", data: "Data Integrity", docs: "Documentation", sec: "Security",
                        reviewTitle: "REVIEW ANSWERS", reviewSub: "Confirm your selections before finalizing the audit.", continueBtn: "FINALIZE AUDIT", editBtn: "GO BACK TO QUESTION", 
                        exportBtn: "EXPORT PDF REPORT", anchor: "REPORT CRYPTOGRAPHIC ANCHOR", copied: "COPIED",
                        ttsPrompt: "Loading Introduction Screen. Click BEGIN ASSESSMENT to start.",
                        // PHASE X: NEW TEXTS
                        tosTitle: "TERMS OF SERVICE", tosBody: "This AI Risk Assessor stores your answers and contact information (if provided) locally in your browser's storage. No data is transmitted to an external server. By continuing, you agree to these terms and the localized data storage.",
                        tosAgree: "I AGREE AND PROCEED", tosDisagree: "DISAGREE & EXIT",
                        userInfoTitle: "CONTACT DETAILS", userInfoBody: "Please provide your email or phone number for audit recordkeeping. This data is stored locally.", userInfoInput: "Enter Email or Phone Number", userInfoContinue: "CONTINUE",
                        userInfoInvalid: "Please enter a valid email or phone number.",
                        troubleshootReset: "TROUBLESHOOT: Reset Session and Start Over"
                    } 
                },
                ES: { 
                    name: "Español", code: "es", dir: "ltr", font: "font-sans", 
                    text: { 
                        title: "IMSSS EVALUADOR", subtitle: "AUDITORÍA ADVERSARIA Y DE RIESGO", startBtn: "INICIAR EVALUACIÓN", reset: "NUEVA SESIÓN", 
                        report: "RESUMEN DE AUDITORÍA", monitoring: "MONITOREO EN VIVO", integrity: "HASH INMUTABLE", metrics: "Métricas del Sistema", 
                        complianceSummary: "RESUMEN DE VIOLACIONES Y ACCIONES", 
                        iso: "Ley IA UE", eu: "Ley IA UE", us: "NIST IA RMF", 
                        gov: "Gobernanza", risk: "Gestión de Riesgos", data: "Integridad de Datos", docs: "Documentación", sec: "Seguridad",
                        reviewTitle: "REVISAR RESPUESTAS", reviewSub: "Confirme sus selecciones antes de finalizar la auditoría.", continueBtn: "FINALIZAR AUDITORÍA", editBtn: "VOLVER A PREGUNTA",
                        exportBtn: "EXPORTAR REPORTE PDF", anchor: "ANCHOR CRIPTOGRÁFICO", copied: "COPIADO",
                        ttsPrompt: "Cargando pantalla de introducción. Haz clic en INICIAR EVALUACIÓN para comenzar.",
                        // PHASE X: NEW TEXTS
                        tosTitle: "TÉRMINOS DE SERVICIO", tosBody: "Este Evaluador de Riesgos de IA almacena sus respuestas e información de contacto (si se proporciona) localmente en el almacenamiento de su navegador. No se transmite ningún dato a un servidor externo. Al continuar, acepta estos términos y el almacenamiento de datos localizado.",
                        tosAgree: "ACEPTO Y CONTINÚO", tosDisagree: "NO ACEPTO Y SALGO",
                        userInfoTitle: "DETALLES DE CONTACTO", userInfoBody: "Proporcione su correo electrónico o número de teléfono para el registro de auditoría. Estos datos se almacenan localmente.", userInfoInput: "Ingrese Correo o Teléfono", userInfoContinue: "CONTINUAR",
                        userInfoInvalid: "Por favor ingrese un correo electrónico o número de teléfono válido.",
                        troubleshootReset: "SOLUCIÓN DE PROBLEMAS: Reiniciar Sesión"
                    } 
                },
                UR: { 
                    name: "اردو", code: "ur", dir: "rtl", font: "font-urdu", 
                    text: { 
                        title: "IMSSS آڈیٹر", subtitle: "مخالفانہ اور رسک آڈٹ", startBtn: "تشخیص شروع کریں", reset: "نئی نشست شروع کریں", 
                        report: "آڈٹ کا خلاصہ", monitoring: "لائیو نگرانی", integrity: "ناقابل تغیر ہیش", metrics: "سسٹم میٹرکس", 
                        complianceSummary: "خلاف ورزی اور ازالے کا خلاصہ", 
                        iso: "آئی ایس او 42001", eu: "یورپی یونین AI ایکٹ", us: "NIST AI RMF", 
                        gov: "انتظامیہ", risk: "رسک مینجمنٹ", data: "ڈیٹا کی سالمیت", docs: "دستاویزات", sec: "سیکیورٹی",
                        reviewTitle: "جوابات کا جائزہ", reviewSub: "آڈٹ کو حتمی شکل دینے سے پہلے اپنی انتخابی تصدیق کریں۔", continueBtn: "آڈٹ کو حتمی شکل دیں", editBtn: "سوال پر واپس جائیں",
                        exportBtn: "پی ڈی ایف رپورٹ ایکسپورٹ کریں", anchor: "رپورٹ کرپٹوگرافک اینکر", copied: "نقل کر لیا",
                        ttsPrompt: "تعارف کی سکرین لوڈ ہو رہی ہے۔ تشخیص شروع کرنے کے لیے شروع کریں پر کلک کریں۔",
                        // PHASE X: NEW TEXTS
                        tosTitle: "سروس کی شرائط", tosBody: "یہ AI رسک آڈیٹر آپ کے جوابات اور رابطہ معلومات (اگر فراہم کی گئی ہو) کو آپ کے براؤزر کے لوکل سٹوریج میں محفوظ کرتا ہے۔ کوئی ڈیٹا بیرونی سرور پر منتقل نہیں ہوتا۔ جاری رکھنے سے، آپ ان شرائط اور مقامی ڈیٹا سٹوریج سے اتفاق کرتے ہیں۔",
                        tosAgree: "میں متفق ہوں اور آگے بڑھتا ہوں", tosDisagree: "متفق نہیں اور باہر نکلیں",
                        userInfoTitle: "رابطہ کی تفصیلات", userInfoBody: "آڈٹ ریکارڈ رکھنے کے لیے اپنا ای میل یا فون نمبر فراہم کریں۔ یہ ڈیٹا مقامی طور پر محفوظ کیا جاتا ہے۔", userInfoInput: "ای میل یا فون نمبر درج کریں", userInfoContinue: "جاری رکھیں",
                        userInfoInvalid: "براہ کرم ایک درست ای میل یا فون نمبر درج کریں۔",
                        troubleshootReset: "خرابی کی درستگی: سیشن ری سیٹ کریں"
                    } 
                }
            };

            // --- 2. AUDIT DATA (AI GRC Focus) ---
            var AUDIT_QUESTIONS = [
                {
                    id: 1, domain: "gov", en: "Does the organization possess a formally signed AI Policy defining accountability and responsibility?", ur: "کیا تنظیم کے پاس ذمہ داری کی وضاحت کرنے والی باضابطہ دستخط شدہ AI پالیسی موجود ہے؟",
                    references: { ISO: "42001: 5.2", EU: "AI Act: Art. 8", US: "NIST AI RMF: Govern" },
                    remediation: { EN: "Formalize Top Management sign-off. Assign clear roles (ISO 42001, 5.3).", ES: "Formalizar la firma de la Alta Dirección. Asignar funciones claras.", UR: "اعلیٰ انتظامیہ کے دستخط کو باضابطہ بنائیں۔ واضح کردار تفویض کریں۔" },
                    riskWeight: 0.25 
                },
                {
                    id: 2, domain: "sec", en: "Has the system undergone adversarial testing (e.g., data poisoning, model evasion, prompt injection defense)?", ur: "کیا سسٹم مخالفانہ جانچ (جیسے ڈیٹا پوائزننگ، ماڈل سے بچاؤ) سے گزرا ہے؟",
                    references: { ISO: "42001: 8.6.2 (Security)", EU: "AI Act: Art. 15 (Robustness)", US: "NIST AI RMF: Manage (Defenses)" },
                    remediation: { EN: "Implement adversarial attack testing/hardening procedures (NIST AI 100-2).", ES: "Implementar procedimientos de prueba/endurecimiento de ataques adversarios.", UR: "مخالفانہ حملے کی جانچ اور سختی کے طریقہ کار کو نافذ کریں۔" },
                    riskWeight: 0.25 
                },
                {
                    id: 3, domain: "risk", en: "Is the AI System subject to mandatory, independent internal audits to verify compliance and risk management?", ur: "کیا AI سسٹم لازمی اندرونی آڈٹ کے تابع ہے؟",
                    references: { ISO: "42001: 9.2", EU: "AI Act: Art. 18", US: "NIST AI RMF: Measure" },
                    remediation: { EN: "Schedule mandatory internal and external audits (ISO 42001, 9.2).", ES: "Programar auditorías internas y externas obligatorias.", UR: "لازمی اندرونی اور بیرونی آڈٹ کا شیڈول بنائیں۔" },
                    riskWeight: 0.1667
                },
                {
                    id: 4, domain: "data", en: "Are statistical controls applied to training data to map, measure, and mitigate algorithmic bias?", ur: "کیا الگورتھم کے تعصب کو کم کرنے کے لیے تربیتی ڈیٹا پر شماریاتی کنٹرول لاگو کیے گئے ہیں؟",
                    references: { ISO: "42001: 8.2", EU: "AI Act: Art. 10", US: "NIST AI RMF: Map" },
                    remediation: { EN: "Establish data quality metrics and bias detection procedures (EU AI Act, Art. 10).", ES: "Establecer métricas de calidad de datos y procedimientos de detección de sesgos.", UR: "ڈیٹا کوالٹی میٹرکس اور تعصب کا پتہ لگانے کے طریقہ کار قائم کریں۔" },
                    riskWeight: 0.1667
                },
                {
                    id: 5, domain: "docs", en: "Is a live Technical File maintained with version history, validation logs, and system specifications for all models?", ur: "کیا تمام ماڈلز کے لیے ورژن ہسٹری اور تصدیقی لاگز کے ساتھ لائیو ٹیکنیکل فائل برقرار رکھی گئی ہے؟",
                    references: { ISO: "42001: 7.5", EU: "AI Act: Art. 11", US: "NIST AI RMF: Manage (Documentation)" },
                    remediation: { EN: "Create an automated log and documentation repository (ISO 42001, 7.5).", ES: "Crear un repositorio automatizado de registro y documentación.", UR: "خودکار لاگ اور دستاویزی ذخیرہ بنائیں۔" },
                    riskWeight: 0.1667
                }
            ];

            // Scoring Options (Simplified labels for quick action)
            var OPTIONS = [
                { label: "YES, Fully Implemented", score: 100 },
                { label: "PARTIAL, Ad-Hoc Only", score: 50 },
                { label: "NO, Not Implemented", score: 0 }
            ];

            var initialScores = { gov: 0, sec: 0, risk: 0, data: 0, docs: 0 };

            // --- 3. A11Y UTILITIES (Speech Synthesis) ---

            var stopSpeaking = function() {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                }
            };

            var speakText = function(text, langCode) {
                // IMPORTANT: This utility is now called ONLY if the React state `ttsEnabled` is true
                if (!('speechSynthesis' in window)) return;
                
                // Add a small delay and force a check to help mobile devices initialize the voice API
                setTimeout(function() {
                    stopSpeaking(); 
                    var utterance = new SpeechSynthesisUtterance(text);
                    
                    var voiceLang = langCode === 'UR' ? 'ur-PK' : langCode === 'ES' ? 'es-ES' : 'en-US';
                    utterance.lang = voiceLang;

                    // Ensure voices are available before trying to select one
                    var voices = window.speechSynthesis.getVoices();
                    var voice = voices.find(function(v) { return v.lang.startsWith(voiceLang.substring(0, 2)); });
                    if (voice) {
                        utterance.voice = voice;
                    }
                    
                    // Start speaking
                    window.speechSynthesis.speak(utterance);

                    // Announce to native screen readers (for redundancy)
                    var announcer = document.getElementById('announcer');
                    if (announcer) announcer.textContent = text;
                }, 50); 
            };


            // --- 4. OTHER UTILITIES ---

            // Function to load state from localStorage
            var loadState = function(key, defaultVal) {
                try {
                    var serialized = localStorage.getItem(key);
                    // Handle booleans correctly: check for "true" or "false" string, otherwise return default
                    if (typeof defaultVal === 'boolean') {
                        if (serialized === 'true') return true;
                        if (serialized === 'false') return false;
                        // For boolean defaults, if serialized is null/undefined, return the default boolean
                        if (serialized === null || serialized === undefined) return defaultVal;
                    }

                    if (serialized === null || serialized === undefined) return defaultVal;
                    // Safely parse JSON or return the string if it's not an object
                    try {
                        return JSON.parse(serialized);
                    } catch (e) {
                        return serialized; // Return as string if parsing fails (for user info, hash, etc.)
                    }
                } catch(e) {
                    console.error("Could not load state:", key, e);
                    return defaultVal;
                }
            };

            // Function to save state to localStorage
            var saveState = function(key, value) {
                try {
                    // Store booleans as strings for consistent loading
                    var serialized = (typeof value === 'boolean') ? String(value) : JSON.stringify(value);
                    // For strings (like user info), ensure we don't double-JSON-encode
                    if (typeof value === 'string' && key === LS_KEY_USERINFO) {
                        serialized = value;
                    }
                    localStorage.setItem(key, serialized);
                } catch (e) {
                    console.error("Could not save state:", key, e);
                }
            };
            
            // Basic validation for email or phone number
            var isValidContact = function(input) {
                if (!input || typeof input !== 'string') return false;
                input = input.trim();
                if (input.length === 0) return false;
                
                // Email regex (simple)
                var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (emailRegex.test(input)) return true;
                
                // Phone number regex (simple: checks for digits, spaces, hyphens, and parentheses)
                var phoneRegex = /^[\s\d\-\(\)\+]{7,20}$/;
                if (phoneRegex.test(input)) return true;
                
                return false;
            };

            // Replaces generateHash with cryptographically secure random values
            var generateCryptoHash = function() {  
                if (typeof window.crypto !== 'undefined' && typeof window.crypto.getRandomValues === 'function') {
                    // Use Crypto API for better randomness (32 bytes = 64 hex chars)
                    var buffer = new Uint8Array(32);
                    window.crypto.getRandomValues(buffer);
                    var hex = Array.prototype.map.call(buffer, function(x) { 
                        return ('00' + x.toString(16)).slice(-2);
                    }).join('');
                    return "0x" + hex.toUpperCase();
                }
                // Fallback (less secure)
                return "0x" + Array(64).fill(0).map(function() {
                    return "0123456789ABCDEF"[Math.random()*16|0];
                }).join('');
            };

            var calculateLiability = function(violations) {
                var MAX_PENALTY_ANCHOR = 50000000;  
                var totalFine = 0;

                for (var i = 0; i < violations.length; i++) {
                    var v = violations[i];
                    var penalty = v.riskWeight * MAX_PENALTY_ANCHOR;  

                    if (v.score === 0) {
                        totalFine += penalty;  
                    } else if (v.score === 50) {
                        totalFine += penalty / 2;
                    }
                }
                return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0 }).format(totalFine);
            };
            
            // Function to find an option label based on score
            var getLabelByScore = function(score) {
                var option = OPTIONS.find(function(o) { return o.score === score; });
                return option ? option.label : 'N/A';
            };


            // --- PDF EXPORT FUNCTION (Phase II) ---
            var exportPdfReport = function(finalHash, userInfo) {
                if (!window.jspdf || !window.html2canvas) {
                    alert("PDF libraries failed to load. Please try refreshing the page.");
                    return;
                }

                var { jsPDF } = window.jspdf;
                var reportElement = document.getElementById('report-container');
                
                // Temporarily clone the element to clean up non-printable styles for the screenshot
                var clone = reportElement.cloneNode(true);
                clone.style.backgroundColor = 'white';
                clone.style.color = 'black';
                clone.querySelectorAll('.neon-text').forEach(function(el) {
                    el.style.textShadow = 'none';
                    el.style.color = 'black';
                });
                clone.querySelectorAll('.text-slate-500, .text-slate-400, .text-slate-300').forEach(function(el) {
                    el.style.color = 'black';
                });
                clone.querySelectorAll('.bg-slate-950, .bg-slate-900\\/50').forEach(function(el) {
                    el.style.backgroundColor = 'white';
                });
                clone.querySelectorAll('.border-slate-700, .border-slate-800').forEach(function(el) {
                    el.style.borderColor = 'lightgray';
                });
                
                // Hide buttons for printing
                clone.querySelectorAll('.no-print').forEach(function(el) {
                    el.style.display = 'none';
                });

                // Prepend the current date and hash to the PDF
                var headerDiv = document.createElement('div');
                headerDiv.innerHTML = '<div style="padding: 15px; border-bottom: 1px solid #ccc; font-family: monospace; font-size: 10px; color: black;">' +
                                        'IMSSS AUDIT REPORT - GENERATED: ' + new Date().toLocaleString() + 
                                        '<br>USER CONTACT: ' + (userInfo || 'N/A') + // Include user info
                                        '<br>IMMUTABLE HASH: ' + finalHash +
                                        '</div>';
                
                document.body.appendChild(headerDiv);
                document.body.appendChild(clone);
                
                // Generate the canvas from the clean clone
                html2canvas(clone, { 
                    scale: 2, 
                    useCORS: true, 
                    logging: false,
                    scrollY: -window.scrollY
                }).then(canvas => {
                    var imgData = canvas.toDataURL('image/png');
                    var pdf = new jsPDF('p', 'mm', 'a4');
                    var imgWidth = 210; 
                    var pageHeight = 295;  
                    var imgHeight = canvas.height * imgWidth / canvas.width;
                    var heightLeft = imgHeight;
                    var position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight; // Corrected variable name
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save("IMSSS_AI_Audit_Report_" + new Date().toISOString().slice(0, 10) + ".pdf");
                    
                    // Clean up temporary elements
                    document.body.removeChild(clone);
                    document.body.removeChild(headerDiv);

                }).catch(function(error) {
                    console.error("PDF Export Failed:", error);
                    alert("PDF Generation failed: " + error.message);
                    
                    // Attempt to clean up even on failure
                    if (document.body.contains(clone)) document.body.removeChild(clone);
                    if (document.body.contains(headerDiv)) document.body.removeChild(headerDiv);
                });
            };


            // --- 5. COMPONENTS & CORE LOGIC ---

            var RiskRadar = function(_ref) {
                var scores = _ref.scores,
                    labels = _ref.labels;

                var size = 180; var center = size / 2; var radius = 70;
                var domains = ["gov", "sec", "risk", "data", "docs"];  

                var points = domains.map(function(d, i) {
                    var angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;  
                    var value = (scores[d] || 0) / 100;  
                    return (center + radius * value * Math.cos(angle)) + "," + (center + radius * value * Math.sin(angle));
                }).join(" ");

                return e('div', { className: "relative flex justify-center py-4", role: "img", "aria-label": "AI Risk Radar Chart" },
                    e('svg', { width: size, height: size, className: "overflow-visible" },
                        // Background grid line (3 layers for better depth)
                        e('circle', { cx: center, cy: center, r: radius * 0.33, fill: "none", stroke: "#334155", strokeDasharray: "4 4" }),
                        e('circle', { cx: center, cy: center, r: radius * 0.66, fill: "none", stroke: "#334155", strokeDasharray: "4 4" }),
                        e('circle', { cx: center, cy: center, r: radius, fill: "none", stroke: "#334155" }),

                        // Domain Spokes
                        domains.map(function(d, i) {
                            var angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                            var x2 = center + radius * Math.cos(angle);
                            var y2 = center + radius * Math.sin(angle);
                            return e('line', { key: 'line-' + d, x1: center, y1: center, x2: x2, y2: y2, stroke: "#334155" });
                        }),

                        // Risk Polygon
                        e('polygon', { points: points, fill: "rgba(59, 130, 246, 0.4)", stroke: "#3b82f6", strokeWidth: 2 }),

                        // Domain Labels (ES5 compatible map)
                        domains.map(function(d, i) {
                            var angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                            var x = center + (radius + 28) * Math.cos(angle);
                            var y = center + (radius + 20) * Math.sin(angle);
                            var getLabel = function(key) { return labels[key]; };
                            return e('text', { 
                                key: d, x: x, y: y, 
                                textAnchor: "middle", 
                                fill: "#94a3b8", 
                                fontSize: "10",
                                className: "uppercase font-bold"
                            }, getLabel(d));
                        })
                    )
                );
            };  

            var HashStream = function(_ref2) {  
                var hash = _ref2.hash;
                return e('div', { className: "font-mono text-[10px] text-emerald-500/60", "aria-live": "polite" }, hash.substring(0,20)+"...");
            };

            // Language Selector Component
            var LangSwitcher = function(_ref3) {
                var current = _ref3.current,
                    setLang = _ref3.setLang,
                    ttsEnabled = _ref3.ttsEnabled,
                    setTtsEnabled = _ref3.setTtsEnabled;

                var languageButtons = Object.keys(LANGUAGES).map(function(code) {
                    var langData = LANGUAGES[code];
                    var className = "px-3 py-1 rounded text-xs font-bold transition-all border " + (current === code ? 'bg-blue-600 border-blue-400 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:text-white');

                    return e('button', {
                        key: code,
                        onClick: function() { setLang(code); },
                        className: className,
                        "aria-pressed": current === code
                    }, langData.name);
                });
                
                // TTS Toggle Button
                var TTSToggle = function() {
                        
                    var toggle = function() {
                        stopSpeaking(); // Stop speaking immediately on toggle
                        setTtsEnabled(!ttsEnabled); // Update state and trigger persistence
                    };

                    var icon = ttsEnabled ? "Volume2" : "VolumeX";
                    var btnClass = ttsEnabled ? 'bg-emerald-600/50 hover:bg-emerald-500/50 border-emerald-500/50' : 'bg-red-600/50 hover:bg-red-500/50 border-red-500/50';

                    return e('button', {
                        onClick: toggle,
                        className: "px-2 py-1 rounded text-xs font-bold transition-all border " + btnClass,
                        "aria-label": ttsEnabled ? "Turn off text to speech" : "Turn on text to speech"
                    }, 
                        e('span', { 'data-lucide': icon, className: "w-4 h-4 text-white" })
                    );
                };


                // Ensure the selector is on the top layer and positioned absolutely 
                return e('div', { className: "absolute top-4 right-4 z-[9999] flex space-x-2 no-print" }, 
                    e(TTSToggle, null), // Added TTS toggle 
                    languageButtons
                );
            };


            // --- SCREEN: TERMS OF SERVICE (Phase X) ---
            var ScreenTOS = function(_ref4) {
                var languageText = _ref4.languageText,
                    setAgreed = _ref4.setAgreed;

                // Function to handle disagreement
                var handleDisagree = function() {
                    alert("You must agree to the Terms of Service to use the IMSSS AI Risk Assessor. The page will now close.");
                    // In a real browser environment, you might try window.close() or redirect
                    // For a GitHub Pages hosted app, we'll just stop the process visually
                    ReactDOM.unmountComponentAtNode(document.getElementById('root'));
                    document.getElementById('root').innerHTML = '<div class="text-white text-center p-10 bg-red-900/50">ACCESS DENIED: Terms not agreed.</div>';
                };

                return e('div', { className: "flex justify-center items-center min-h-screen p-4" },
                    e('div', { className: "glass-panel p-8 w-full max-w-md text-center rounded-lg shadow-2xl text-white", dir: LANGUAGES[languageText.code].dir },
                        e('h2', { className: "text-2xl font-bold mb-4 neon-text" }, languageText.text.tosTitle),
                        e('p', { className: "text-slate-300 mb-8" }, languageText.text.tosBody),

                        e('button', {
                            onClick: function() { setAgreed(true); },
                            className: "w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg mb-4 transition-colors"
                        }, languageText.text.tosAgree),

                        e('button', {
                            onClick: handleDisagree,
                            className: "w-full py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors"
                        }, languageText.text.tosDisagree)
                    )
                );
            };

            // --- SCREEN: USER INFO / CONTACT DETAILS (Phase X) ---
            var ScreenUserInfo = function(_ref5) {
                var languageText = _ref5.languageText,
                    setUserInfo = _ref5.setUserInfo,
                    resetSession = _ref5.resetSession;

                var _useState = useState(""),
                    localContact = _useState[0],
                    setLocalContact = _useState[1];
                
                var _useState2 = useState(false),
                    error = _useState2[0],
                    setError = _useState2[1];

                var handleSubmit = function() {
                    if (isValidContact(localContact)) {
                        setError(false);
                        setUserInfo(localContact); // This will move the user to the next screen (Intro)
                        saveState(LS_KEY_USERINFO, localContact);
                    } else {
                        setError(true);
                    }
                };

                return e('div', { className: "flex justify-center items-center min-h-screen p-4" },
                    e('div', { className: "glass-panel p-8 w-full max-w-md text-center rounded-lg shadow-2xl text-white", dir: LANGUAGES[languageText.code].dir },
                        e('h2', { className: "text-2xl font-bold mb-2 neon-text" }, languageText.text.userInfoTitle),
                        e('p', { className: "text-slate-300 mb-6 text-sm" }, languageText.text.userInfoBody),

                        // Input Field
                        e('div', { className: "mb-4" },
                            e('input', {
                                type: "text", // Use text for email/phone flexibility
                                value: localContact,
                                onChange: function(e) { setLocalContact(e.target.value); setError(false); },
                                onKeyDown: function(e) { if (e.key === 'Enter') { handleSubmit(); } },
                                placeholder: languageText.text.userInfoInput,
                                'aria-label': languageText.text.userInfoInput,
                                'aria-invalid': error,
                                className: "w-full px-4 py-3 bg-[var(--input-bg)] border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500",
                                disabled: false // Ensure the input is not disabled
                            })
                        ),

                        // Error Message
                        error && e('p', { className: "text-red-500 text-sm mb-4" }, languageText.text.userInfoInvalid),

                        // Continue Button
                        e('button', {
                            onClick: handleSubmit,
                            className: "w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors mb-6",
                            disabled: !isValidContact(localContact) // Disable until input is valid
                        }, languageText.text.userInfoContinue),
                        
                        // TROUBLESHOOT Reset Button (Moved to bottom)
                        e('button', {
                            onClick: resetSession,
                            className: "text-xs text-slate-500 hover:text-red-400 underline transition-colors"
                        }, languageText.text.troubleshootReset)
                    )
                );
            };

            // --- SCREEN: INTRO & ASSESSMENT LAYOUT (Previous Code) ---
            var Layout = function(_ref6) {
                var languageText = _ref6.languageText,
                    setStarted = _ref6.setStarted,
                    ttsEnabled = _ref6.ttsEnabled;

                useEffect(function() {
                    // Speak the prompt when this screen loads and TTS is enabled
                    if (ttsEnabled) {
                        speakText(languageText.text.ttsPrompt, languageText.code);
                    }
                    return stopSpeaking;
                }, [languageText, ttsEnabled]);

                return e('div', { className: "flex justify-center items-center min-h-screen p-4", dir: LANGUAGES[languageText.code].dir },
                    e('div', { className: "glass-panel p-8 w-full max-w-md text-center rounded-lg shadow-2xl text-white" },
                        e('h1', { className: "text-4xl font-bold mb-2 neon-text" }, languageText.text.title),
                        e('p', { className: "text-slate-400 mb-8 font-sans" }, languageText.text.subtitle),
                        e('button', {
                            onClick: function() { setStarted(true); stopSpeaking(); },
                            className: "w-full py-4 bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold rounded-lg transition-colors"
                        }, languageText.text.startBtn)
                    )
                );
            };

            // ... (Other components like ScreenQuestion, ScreenReview, ScreenReport, and utility functions remain the same) ...
            
            // --- SCREEN: QUESTION ---
            var ScreenQuestion = function(_ref7) {
                var currentQ = _ref7.currentQ,
                    setCurrentQ = _ref7.setCurrentQ,
                    languageText = _ref7.languageText,
                    answers = _ref7.answers,
                    setAnswers = _ref7.setAnswers,
                    scores = _ref7.scores,
                    setScores = _ref7.setScores,
                    setFinished = _ref7.setFinished,
                    ttsEnabled = _ref7.ttsEnabled;

                var qIndex = currentQ; // 0-indexed for array access
                var question = AUDIT_QUESTIONS[qIndex];
                var qText = question[languageText.code];
                var domainText = languageText.text[question.domain];

                // TTS Effect
                useEffect(function() {
                    if (ttsEnabled) {
                        var speechText = languageText.code === 'EN' ? "Question " + (currentQ + 1) + " of " + AUDIT_QUESTIONS.length + ", in " + domainText + ". " + qText : qText;
                        speakText(speechText, languageText.code);
                    }
                    return stopSpeaking;
                }, [qText, domainText, ttsEnabled, currentQ]);


                var handleAnswer = function(score) {
                    var newAnswers = {};
                    newAnswers[question.id] = score;
                    setAnswers(Object.assign({}, answers, newAnswers)); // Add answer

                    // Calculate new domain score
                    var newScores = Object.assign({}, scores);
                    newScores[question.domain] = score;
                    setScores(newScores);

                    // Move to next question or finish
                    if (currentQ < AUDIT_QUESTIONS.length - 1) {
                        setCurrentQ(currentQ + 1);
                    } else {
                        setFinished(true); // All questions answered
                    }
                };

                return e('div', { className: "flex justify-center items-center min-h-screen p-4", dir: LANGUAGES[languageText.code].dir },
                    e('div', { className: "glass-panel p-6 w-full max-w-lg rounded-lg shadow-2xl text-white" },
                        e('div', { className: "flex justify-between items-center mb-6 border-b border-slate-700 pb-4" },
                            e('p', { className: "text-lg font-bold text-blue-400 neon-text" }, languageText.code === 'UR' ? `${AUDIT_QUESTIONS.length} میں سے ${currentQ + 1} سوال` : `QUESTION ${currentQ + 1} OF ${AUDIT_QUESTIONS.length}`),
                            e('span', { className: "text-sm font-bold bg-slate-800 px-3 py-1 rounded-full text-slate-300 uppercase" }, domainText)
                        ),
                        e('h2', { className: "text-2xl font-bold mb-8", lang: languageText.code, dir: languageText.dir }, qText),

                        e('div', { className: "space-y-4" },
                            OPTIONS.map(function(option) {
                                var isSelected = answers[question.id] === option.score;
                                var buttonClass = isSelected
                                    ? (option.score === 100 ? 'bg-emerald-600 border-emerald-500' : option.score === 50 ? 'bg-amber-600 border-amber-500' : 'bg-red-600 border-red-500') + ' text-white'
                                    : 'bg-slate-800 hover:bg-slate-700 border-slate-700 hover:border-blue-500 text-slate-300';

                                return e('button', {
                                    key: option.score,
                                    onClick: function() { handleAnswer(option.score); },
                                    className: "w-full py-4 text-left px-5 font-bold rounded-lg border-2 transition-all " + buttonClass,
                                    'aria-current': isSelected ? 'true' : 'false'
                                }, option.label);
                            })
                        ),
                        
                        // Back Button
                        currentQ > 0 && e('button', {
                            onClick: function() { setCurrentQ(currentQ - 1); stopSpeaking(); },
                            className: "mt-6 text-sm text-slate-500 hover:text-slate-300 underline transition-colors"
                        }, languageText.code === 'UR' ? "پچھلا سوال" : "GO BACK")
                    )
                );
            };

            // --- SCREEN: REVIEW ---
            var ScreenReview = function(_ref8) {
                var languageText = _ref8.languageText,
                    answers = _ref8.answers,
                    scores = _ref8.scores,
                    setReviewed = _ref8.setReviewed,
                    setFinalHash = _ref8.setFinalHash,
                    setCurrentQ = _ref8.setCurrentQ,
                    ttsEnabled = _ref8.ttsEnabled;

                var _useState = useState(false),
                    isReviewing = _useState[0],
                    setIsReviewing = _useState[1];
                
                // TTS Effect
                useEffect(function() {
                    if (ttsEnabled) {
                        var speechText = languageText.code === 'EN' ? "Review your answers before finalizing the audit." : languageText.text.reviewSub;
                        speakText(speechText, languageText.code);
                    }
                    return stopSpeaking;
                }, [languageText, ttsEnabled]);

                // Create a deterministic hash from the answers and current date (for immutability)
                var generateReportHash = function() {
                    var dataString = JSON.stringify(answers) + new Date().toISOString().slice(0, 10);
                    var hashValue = 0;
                    for (var i = 0; i < dataString.length; i++) {
                        var char = dataString.charCodeAt(i);
                        hashValue = ((hashValue << 5) - hashValue) + char;
                        hashValue |= 0; // Convert to 32bit integer
                    }
                    // Add a strong random element for practical anchor security
                    return generateCryptoHash() + hashValue.toString(16).toUpperCase();
                };

                var finalizeAudit = function() {
                    // Generate and save the final hash
                    var hash = generateReportHash();
                    setFinalHash(hash);
                    saveState(LS_KEY_HASH, hash);
                    
                    setReviewed(true); // Move to Report Screen
                };
                
                // Determine the highest risk score among domains (lowest score = highest risk)
                var riskDomains = AUDIT_QUESTIONS.map(function(q) { return q.domain; });
                var domainScores = riskDomains.map(function(d) { return scores[d] || 0; });
                var minScore = Math.min.apply(null, domainScores);
                var mostCriticalDomains = riskDomains.filter(function(d) { return (scores[d] || 0) === minScore; });

                return e('div', { className: "flex justify-center items-center min-h-screen p-4", dir: LANGUAGES[languageText.code].dir },
                    e('div', { className: "glass-panel p-6 w-full max-w-xl rounded-lg shadow-2xl text-white" },
                        e('h2', { className: "text-3xl font-bold mb-2 neon-text" }, languageText.text.reviewTitle),
                        e('p', { className: "text-slate-400 mb-6" }, languageText.text.reviewSub),

                        e('div', { className: "space-y-4 mb-8" },
                            AUDIT_QUESTIONS.map(function(q, index) {
                                var answerScore = answers[q.id];
                                var answerLabel = getLabelByScore(answerScore);
                                
                                var borderColor = answerScore === 100 ? 'border-emerald-500' : answerScore === 50 ? 'border-amber-500' : 'border-red-500';
                                var bgColor = answerScore === 100 ? 'bg-emerald-900/30' : answerScore === 50 ? 'bg-amber-900/30' : 'bg-red-900/30';

                                return e('div', { key: q.id, className: "p-4 border-l-4 rounded-r-lg " + borderColor + ' ' + bgColor },
                                    e('h3', { className: "text-sm font-semibold uppercase text-slate-400 mb-1" }, languageText.text[q.domain]),
                                    e('p', { className: "font-bold text-lg mb-2" }, q[languageText.code]),
                                    e('p', { className: "text-sm text-slate-300 mb-3" }, e('span', { className: "font-semibold" }, languageText.code === 'UR' ? "آپ کا جواب: " : "YOUR ANSWER: "), e('span', { className: "font-bold" }, answerLabel)),
                                    e('button', {
                                        onClick: function() { setCurrentQ(index); setReviewed(false); stopSpeaking(); },
                                        className: "px-4 py-2 text-xs font-bold rounded bg-slate-700 hover:bg-slate-600 text-white transition-colors"
                                    }, languageText.text.editBtn)
                                );
                            })
                        ),

                        e('button', {
                            onClick: finalizeAudit,
                            className: "w-full py-4 bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold rounded-lg transition-colors"
                        }, languageText.text.continueBtn)
                    )
                );
            };


            // --- SCREEN: REPORT ---
            var ScreenReport = function(_ref9) {
                var languageText = _ref9.languageText,
                    answers = _ref9.answers,
                    scores = _ref9.scores,
                    finalHash = _ref9.finalHash,
                    userInfo = _ref9.userInfo,
                    resetSession = _ref9.resetSession,
                    copied = _ref9.copied,
                    setCopied = _ref9.setCopied,
                    hashStream = _ref9.hashStream,
                    ttsEnabled = _ref9.ttsEnabled;

                // TTS Effect
                useEffect(function() {
                    if (ttsEnabled) {
                        var speechText = languageText.code === 'EN' ? "Audit summary report generated. Confidence score is " + calculateOverallScore(scores) + " percent. Projected EU liability is " + calculateLiability(getViolations(answers)) : languageText.text.report;
                        speakText(speechText, languageText.code);
                    }
                    return stopSpeaking;
                }, [languageText, ttsEnabled, scores]);


                var getViolations = function(ans) {
                    return AUDIT_QUESTIONS.filter(function(q) {
                        var score = ans[q.id];
                        return score === 0 || score === 50;
                    }).map(function(q) {
                        return Object.assign({}, q, {
                            score: ans[q.id],
                            status: ans[q.id] === 0 ? 'FAIL' : 'PARTIAL'
                        });
                    });
                };
                
                var calculateOverallScore = function(s) {
                    var totalScore = Object.keys(s).reduce(function(acc, key) { return acc + s[key]; }, 0);
                    return Math.round(totalScore / 5);
                };

                var violations = getViolations(answers);
                var overallScore = calculateOverallScore(scores);
                var liability = calculateLiability(violations);
                var domainLabels = {
                    gov: languageText.text.gov, sec: languageText.text.sec, risk: languageText.text.risk,
                    data: languageText.text.data, docs: languageText.text.docs
                };

                var copyHash = function() {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(finalHash).then(function() {
                            setCopied(true);
                            setTimeout(function() { setCopied(false); }, 3000);
                        }).catch(function(err) {
                            console.error('Could not copy text: ', err);
                            alert("Copy failed. Hash: " + finalHash);
                        });
                    } else {
                        alert("Clipboard API not supported. Hash: " + finalHash);
                    }
                };

                var getStatusColor = function(status) {
                    return status === 'FAIL' ? 'text-red-500' : status === 'PARTIAL' ? 'text-amber-500' : 'text-emerald-500';
                };

                return e('div', { className: "flex justify-center items-center min-h-screen p-4", dir: LANGUAGES[languageText.code].dir },
                    e('div', { id: "report-container", className: "glass-panel p-6 w-full max-w-xl rounded-lg shadow-2xl text-white report-container" },
                        e('h2', { className: "text-3xl font-bold mb-4 text-center neon-text" }, languageText.text.report),
                        
                        // Confidence Score
                        e('div', { className: "text-center mb-6 p-4 rounded-lg bg-slate-900/50" },
                            e('p', { className: "text-lg text-slate-400 mb-1" }, "CONFIDENCE SCORE"),
                            e('p', { className: "text-5xl font-extrabold " + getStatusColor(overallScore < 50 ? 'FAIL' : 'PARTIAL') }, overallScore + "%")
                        ),

                        // Projected Liability (EU AI Act Focus)
                        e('div', { className: "text-center mb-6 p-4 rounded-lg bg-red-900/50 border border-red-800" },
                            e('p', { className: "text-lg text-red-300 mb-1" }, "PROJECTED EU LIABILITY"),
                            e('p', { className: "text-4xl font-extrabold text-white" }, liability)
                        ),
                        
                        // Risk Radar
                        e('div', { className: "text-center mb-6 p-4 rounded-lg bg-slate-900/50" },
                            e('p', { className: "text-lg text-slate-400 mb-4" }, "RISK TOPOLOGY"),
                            e(RiskRadar, { scores: scores, labels: domainLabels })
                        ),

                        // Cryptographic Anchor
                        e('div', { className: "text-center mb-6 p-4 rounded-lg bg-slate-900/50 border border-slate-700" },
                            e('p', { className: "text-sm text-slate-400 mb-2" }, languageText.text.anchor),
                            e('div', { className: "font-mono text-sm text-emerald-400 break-all mb-3" }, finalHash),
                            e('button', {
                                onClick: copyHash,
                                className: "no-print px-4 py-2 text-xs font-bold rounded " + (copied ? 'bg-emerald-600' : 'bg-blue-600 hover:bg-blue-700') + " text-white transition-colors",
                                'aria-label': copied ? 'Hash Copied' : 'Copy Report Cryptographic Anchor'
                            }, copied ? languageText.text.copied : languageText.text.anchor)
                        ),

                        // Violation Summary
                        e('div', { className: "mb-8" },
                            e('h3', { className: "text-xl font-bold mb-4 neon-text" }, languageText.text.complianceSummary),
                            violations.length > 0 ? (
                                violations.map(function(v) {
                                    var statusColor = getStatusColor(v.status);
                                    var bgColor = v.status === 'FAIL' ? 'bg-red-900/50' : 'bg-amber-900/50';
                                    var refString = "Ref: ";
                                    Object.keys(v.references).forEach(function(key) {
                                        refString += key + " " + v.references[key] + ", ";
                                    });
                                    refString = refString.slice(0, -2); // Remove trailing comma and space

                                    return e('div', { key: v.id, className: "p-4 rounded-lg mb-4 " + bgColor + " border border-slate-700" },
                                        e('h4', { className: "text-lg font-bold uppercase mb-1" }, languageText.text[v.domain] + " - " + e('span', { className: statusColor }, v.status)),
                                        e('p', { className: "text-sm text-slate-300 mb-2" }, "ACTION REQUIRED:"),
                                        e('p', { className: "text-sm font-semibold text-white mb-3" }, v.remediation[languageText.code]),
                                        e('p', { className: "text-xs text-slate-500 font-mono" }, refString)
                                    );
                                })
                            ) : (
                                e('p', { className: "text-lg text-emerald-500 font-bold" }, languageText.code === 'UR' ? "تمام تقاضے مکمل ہیں" : "All requirements fully met. No major violations found.")
                            )
                        ),

                        // Report Actions
                        e('div', { className: "no-print space-y-4" },
                            e('button', {
                                onClick: function() { exportPdfReport(finalHash, userInfo); },
                                className: "w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg transition-colors"
                            }, languageText.text.exportBtn),

                            e('button', {
                                onClick: resetSession,
                                className: "w-full py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-lg transition-colors"
                            }, languageText.text.reset)
                        )
                    )
                );
            };


            // --- MAIN APP COMPONENT ---
            var App = function() {
                // ... (State initialization remains the same) ...
                
                // --- Load initial state from LocalStorage ---
                var initialLang = loadState(LS_KEY_LANG, 'EN');
                var initialAnswers = loadState(LS_KEY_ANSWERS, {});
                var initialScoresFromLS = loadState(LS_KEY_SCORES, initialScores);
                var initialFinalHash = loadState(LS_KEY_HASH, null);
                var initialTtsEnabled = loadState(LS_KEY_TTS, false); 
                
                // PHASE X: Load ToS agreement and User Info
                var initialAgreed = loadState(LS_KEY_AGREED, false);
                var initialUserInfo = loadState(LS_KEY_USERINFO, null); 


                // Determine starting progress:
                var answerKeys = Object.keys(initialAnswers);
                var initialQ = answerKeys.length > 0 ? answerKeys.length : 0;
                // Assessment is only 'started' if user info is present AND progress exists
                var initialStarted = (initialQ > 0 || loadState(LS_KEY_PROGRESS, false)) && initialUserInfo !== null; 
                var initialFinished = initialQ === AUDIT_QUESTIONS.length;
                var initialReviewed = initialFinalHash !== null;
                
                // If finished on last load, set up for review or report view
                if (initialReviewed) { initialFinished = true; } 
                else if (initialFinished) { initialStarted = true; } 

                // State initialization
                var _useState = useState(initialLang),
                    lang = _useState[0],
                    setLang = _useState[1];

                var _useState2 = useState(initialStarted),
                    started = _useState2[0],
                    setStarted = _useState2[1];

                var _useState3 = useState(initialQ),
                    currentQ = _useState3[0],
                    setCurrentQ = _useState3[1];
                
                var _useState9 = useState(initialFinished),
                    finished = _useState9[0],
                    setFinished = _useState9[1];

                var _useState4 = useState(initialReviewed),
                    reviewed = _useState4[0],
                    setReviewed = _useState4[1];

                var _useState5 = useState(initialScoresFromLS),
                    scores = _useState5[0],
                    setScores = _useState5[1];

                var _useState6 = useState(initialAnswers),
                    answers = _useState6[0],
                    setAnswers = _useState6[1];
                
                var _useState7 = useState(initialFinalHash),
                    finalHash = _useState7[0],
                    setFinalHash = _useState7[1];

                var _useState8 = useState(generateCryptoHash()),
                    hashStream = _useState8[0],
                    setHashStream = _useState8[1];
                
                var _useState10 = useState(false), // For Copy Button feedback
                    copied = _useState10[0],
                    setCopied = _useState10[1];

                var _useState11 = useState(initialTtsEnabled), 
                    ttsEnabled = _useState11[0],
                    setTtsEnabled = _useState11[1];
                    
                // PHASE X: NEW STATES
                var _useState12 = useState(initialAgreed),
                    agreed = _useState12[0],
                    setAgreed = _useState12[1];
                
                var _useState13 = useState(initialUserInfo),
                    userInfo = _useState13[0],
                    setUserInfo = _useState13[1];


                // Persistence Effects (Save state on change)
                useEffect(function() { saveState(LS_KEY_LANG, lang); }, [lang]);
                useEffect(function() { saveState(LS_KEY_ANSWERS, answers); saveState(LS_KEY_SCORES, scores); }, [answers, scores]);
                useEffect(function() { saveState(LS_KEY_PROGRESS, started); }, [started]);
                useEffect(function() { saveState(LS_KEY_HASH, finalHash); }, [finalHash]);
                useEffect(function() { saveState(LS_KEY_TTS, ttsEnabled); }, [ttsEnabled]);
                
                // PHASE X: Persistence for TOS and User Info
                useEffect(function() { saveState(LS_KEY_AGREED, agreed); }, [agreed]);
                useEffect(function() { saveState(LS_KEY_USERINFO, userInfo); }, [userInfo]);


                // HashStream Updater (for "Live Monitoring")
                useEffect(function() {
                    var interval = setInterval(function() {
                        setHashStream(generateCryptoHash());
                    }, 500); // Faster update for better visual effect

                    return function() { clearInterval(interval); };
                }, []);
                
                // Reset Function (for new session button)
                var resetSession = function() {
                    stopSpeaking();
                    localStorage.clear();
                    // Reset all React state to initial values, forcing a full screen reset
                    setLang('EN');
                    setStarted(false);
                    setCurrentQ(0);
                    setFinished(false);
                    setReviewed(false);
                    setScores(initialScores);
                    setAnswers({});
                    setFinalHash(null);
                    setAgreed(false);
                    setUserInfo(null);
                    setTtsEnabled(false);
                    // Force a hard page reload to ensure all memory is cleared (best practice for full reset)
                    window.location.reload();
                };

                // Determine the current language text object
                var currentLangText = LANGUAGES[lang];

                // --- RENDER LOGIC: Determine which screen to show ---
                
                // 1. Must agree to TOS first
                if (!agreed) return e('div', { className: currentLangText.font + ' ' + currentLangText.dir }, 
                    e(LangSwitcher, { current: lang, setLang: setLang, ttsEnabled: ttsEnabled, setTtsEnabled: setTtsEnabled }),
                    e(ScreenTOS, { languageText: currentLangText, setAgreed: setAgreed })
                );

                // 2. Must enter user info next (only if agreed)
                if (agreed && !userInfo) return e('div', { className: currentLangText.font + ' ' + currentLangText.dir }, 
                    e(LangSwitcher, { current: lang, setLang: setLang, ttsEnabled: ttsEnabled, setTtsEnabled: setTtsEnabled }),
                    e(ScreenUserInfo, { languageText: currentLangText, setUserInfo: setUserInfo, resetSession: resetSession })
                );

                // 3. Show Final Report
                if (reviewed) return e('div', { className: currentLangText.font + ' ' + currentLangText.dir }, 
                    e(LangSwitcher, { current: lang, setLang: setLang, ttsEnabled: ttsEnabled, setTtsEnabled: setTtsEnabled }),
                    e(ScreenReport, {
                        languageText: currentLangText,
                        answers: answers,
                        scores: scores,
                        finalHash: finalHash,
                        userInfo: userInfo,
                        resetSession: resetSession,
                        copied: copied,
                        setCopied: setCopied,
                        hashStream: hashStream,
                        ttsEnabled: ttsEnabled
                    })
                );

                // 4. Show Review Screen
                if (finished) return e('div', { className: currentLangText.font + ' ' + currentLangText.dir }, 
                    e(LangSwitcher, { current: lang, setLang: setLang, ttsEnabled: ttsEnabled, setTtsEnabled: setTtsEnabled }),
                    e(ScreenReview, {
                        languageText: currentLangText,
                        answers: answers,
                        scores: scores,
                        setReviewed: setReviewed,
                        setFinalHash: setFinalHash,
                        setCurrentQ: setCurrentQ,
                        ttsEnabled: ttsEnabled
                    })
                );

                // 5. Show Questions Screen
                if (started) return e('div', { className: currentLangText.font + ' ' + currentLangText.dir }, 
                    e(LangSwitcher, { current: lang, setLang: setLang, ttsEnabled: ttsEnabled, setTtsEnabled: setTtsEnabled }),
                    e(ScreenQuestion, {
                        currentQ: currentQ,
                        setCurrentQ: setCurrentQ,
                        languageText: currentLangText,
                        answers: answers,
                        setAnswers: setAnswers,
                        scores: scores,
                        setScores: setScores,
                        setFinished: setFinished,
                        ttsEnabled: ttsEnabled
                    })
                );

                // 6. Show Intro Screen
                return e('div', { className: currentLangText.font + ' ' + currentLangText.dir }, 
                    e(LangSwitcher, { current: lang, setLang: setLang, ttsEnabled: ttsEnabled, setTtsEnabled: setTtsEnabled }),
                    e(Layout, { languageText: currentLangText, setStarted: setStarted, ttsEnabled: ttsEnabled })
                );
            };

            // --- RENDER APPLICATION ---
            ReactDOM.render(e(App, null), document.getElementById('root'), function() {
                // Ensure Lucide icons are rendered after initial React render
                if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }
            });

        }
    </script>

    <script>
        // Initial icon rendering attempt for load screen
        if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
            lucide.createIcons();
        }
    </script>
</body>
</html>
