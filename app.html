<!-- 
  AI Compliance Readiness Assessment and Reporting Tool
  
  This single-file application uses Tailwind CSS for styling, 
  Firebase Firestore for real-time, persistent data storage, 
  and CryptoJS for generating secure audit hashes. 
  It simulates an AI compliance audit process based on 
  structured regulatory frameworks.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Compliance Assessor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#1e293b',
                        'card-bg': '#334155',
                        'primary-green': '#10b981',
                        'secondary-blue': '#3b82f6',
                        'low-risk': '#10b981',
                        'moderate-risk': '#f59e0b',
                        'high-risk': '#ef4444',
                    }
                }
            }
        }
    </script>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Disable log messages for production environment
        // setLogLevel('Debug'); // Uncomment for debugging
        
        // Global Variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = 'anonymous';

        // --- Firebase Initialization and Authentication ---
        window.initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. Cannot initialize Firebase.");
                    document.getElementById('auth-status').textContent = 'Error (config-missing)';
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                window.db = db; // Make db globally accessible for saveAssessment

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('auth-status').textContent = `Auth Complete. User ID: ${userId.substring(0, 10)}...`;
                        window.userId = userId; // Make userId globally accessible
                        // Start listeners or data fetch after auth
                    } else {
                        // User is signed out (e.g., anonymous sign-in failed or sign-out occurred)
                        userId = crypto.randomUUID(); // Fallback to a random ID
                        document.getElementById('auth-status').textContent = 'Auth Failed. Using random ID.';
                        window.userId = userId;
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or auth error:", error);
                document.getElementById('auth-status').textContent = `Error (${error.code || error.message})`;
            }
        };

        window.initFirebase();
    </script>
    <!-- Load Chart.js and CryptoJS for the Report View -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Style for the remediation list */
        .remediation-item {
            display: flex;
            align-items: flex-start;
            padding: 1rem 0;
            border-bottom: 1px solid #475569;
        }
        .remediation-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-dark-bg text-gray-100 min-h-screen">

    <div id="app" class="flex flex-col lg:flex-row h-full">

        <!-- Sidebar / Assessment Setup (Always Visible on Left/Top) -->
        <div id="setup-sidebar" class="w-full lg:w-96 bg-card-bg p-6 space-y-6 flex-shrink-0 rounded-b-xl lg:rounded-r-xl lg:rounded-b-none shadow-2xl">
            <h1 class="text-3xl font-bold text-primary-green flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><path d="M22 4L12 14.01l-3-3"></path></svg>
                IMSSS Assessor
            </h1>
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2">New Assessment</h2>

            <form id="assessment-form" class="space-y-4">
                <h3 class="text-lg font-medium pt-2 border-t border-gray-700">AI System Context (5 Key Questions)</h3>
                
                <!-- Structured AI System Description Inputs -->
                <div class="space-y-3">
                    <div class="space-y-1">
                        <label for="system-purpose" class="text-sm font-medium">1. Purpose: What does the AI system do?</label>
                        <input type="text" id="system-purpose" required class="w-full p-3 bg-gray-700 text-gray-100 rounded-lg border border-gray-600 focus:border-primary-green focus:ring-primary-green transition-colors" placeholder="e.g., NLP model for credit scoring.">
                    </div>

                    <div class="space-y-1">
                        <label for="system-deployment" class="text-sm font-medium">2. Deployment: Where is it used?</label>
                        <input type="text" id="system-deployment" required class="w-full p-3 bg-gray-700 text-gray-100 rounded-lg border border-gray-600 focus:border-primary-green focus:ring-primary-green transition-colors" placeholder="e.g., Production environment, Internal testing only.">
                    </div>

                    <div class="space-y-1">
                        <label for="system-impact" class="text-sm font-medium">3. Impact: Who or what does it affect?</label>
                        <input type="text" id="system-impact" required class="w-full p-3 bg-gray-700 text-gray-100 rounded-lg border border-gray-600 focus:border-primary-green focus:ring-primary-green transition-colors" placeholder="e.g., Consumer finance, Hiring decisions (High Risk).">
                    </div>

                    <div class="space-y-1">
                        <label for="system-data" class="text-sm font-medium">4. Key Data: What kind of data does it process?</label>
                        <input type="text" id="system-data" required class="w-full p-3 bg-gray-700 text-gray-100 rounded-lg border border-gray-600 focus:border-primary-green focus:ring-primary-green transition-colors" placeholder="e.g., PII, Medical records, Sensor data.">
                    </div>
                    
                    <!-- NEW JURISDICTION FIELD -->
                    <div class="space-y-1">
                        <label for="system-provider-location" class="text-sm font-medium text-yellow-300">5. Provider Location: Where is the AI provider/developer registered?</label>
                        <input type="text" id="system-provider-location" required class="w-full p-3 bg-gray-700 text-gray-100 rounded-lg border border-gray-600 focus:border-primary-green focus:ring-primary-green transition-colors" placeholder="e.g., USA (Delaware), Ireland (EU), Singapore.">
                    </div>
                </div>

                <!-- Risk Category Selection -->
                <div class="space-y-1 pt-4 border-t border-gray-700">
                    <label for="risk-category" class="text-sm font-medium">Select Risk Category (EU AI Act based)</label>
                    <select id="risk-category" required class="w-full p-3 bg-gray-700 text-gray-100 rounded-lg border border-gray-600 focus:border-primary-green focus:ring-primary-green transition-colors">
                        <option value="1">Limited Risk (LR) - e.g., Basic chatbot</option>
                        <option value="3" selected>Minimal Risk (MR) - e.g., Inventory optimization</option>
                        <option value="5">High Risk (HR) - e.g., Critical infrastructure, HR/Finance decisions</option>
                    </select>
                </div>

                <!-- Compliance Domains Selection -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Key Compliance Domains (Select all applicable)</label>
                    <div class="space-y-1 text-sm bg-gray-700 p-3 rounded-lg">
                        <div class="flex items-center">
                            <input type="checkbox" id="domain-data" name="domains" value="Data Quality and Governance" checked class="form-checkbox h-4 w-4 text-primary-green rounded bg-gray-600 border-gray-500 focus:ring-primary-green">
                            <label for="domain-data" class="ml-2">Data Quality and Governance</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="domain-model" name="domains" value="Model Transparency and Explainability" checked class="form-checkbox h-4 w-4 text-primary-green rounded bg-gray-600 border-gray-500 focus:ring-primary-green">
                            <label for="domain-model" class="ml-2">Model Transparency and Explainability</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="domain-bias" name="domains" value="Bias and Fairness Assessment" checked class="form-checkbox h-4 w-4 text-primary-green rounded bg-gray-600 border-gray-500 focus:ring-primary-green">
                            <label for="domain-bias" class="ml-2">Bias and Fairness Assessment</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="domain-security" name="domains" value="Robustness and Security" checked class="form-checkbox h-4 w-4 text-primary-green rounded bg-gray-600 border-gray-500 focus:ring-primary-green">
                            <label for="domain-security" class="ml-2">Robustness and Security</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="domain-governance" name="domains" value="Model Governance and Oversight" checked class="form-checkbox h-4 w-4 text-primary-green rounded bg-gray-600 border-gray-500 focus:ring-primary-green">
                            <label for="domain-governance" class="ml-2">Model Governance and Oversight</label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="w-full bg-primary-green hover:bg-green-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md">
                    Run Compliance Assessment
                </button>
            </form>
            <p id="auth-status" class="text-xs text-gray-400 text-center mt-4">Initializing Firebase...</p>
            <p class="text-xs text-gray-400 text-center">User ID: <span id="display-user-id">Loading...</span></p>
        </div>
        
        <!-- Main Content Area (Assessment or Report) -->
        <main id="main-content" class="flex-grow p-6 overflow-y-auto">
            <!-- Initial State / Welcome Screen -->
            <div id="welcome-screen" class="max-w-3xl mx-auto text-center py-20">
                <h2 class="text-4xl font-extrabold text-white mb-4">AI Compliance Readiness Tool</h2>
                <p class="text-lg text-gray-300 mb-8">Start a new assessment using the form on the left to evaluate your AI system's compliance maturity across key regulatory domains.</p>
                <div class="inline-flex items-center space-x-4 text-left p-4 bg-gray-700 rounded-lg shadow-inner">
                    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-9 h-9"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    <p class="text-gray-300 text-sm">Please answer the **5 context questions** precisely to tailor the audit results effectively, including the provider's legal location.</p>
                </div>
            </div>

            <!-- Assessment Screen (Hidden initially) -->
            <div id="assessment-screen" class="hidden max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">AI Compliance Assessment</h2>
                    <div class="flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-secondary-blue"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                        <span id="current-question-indicator" class="text-lg font-medium text-secondary-blue">1 / 0</span>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full bg-gray-700 rounded-full h-2.5 mb-8">
                    <div id="progress-bar" class="bg-primary-green h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>

                <!-- Question Card -->
                <div id="question-card" class="bg-card-bg p-8 rounded-xl shadow-lg space-y-6">
                    <p id="question-domain" class="text-sm font-semibold text-primary-green uppercase tracking-wider">Domain: Loading...</p>
                    <h3 id="question-text" class="text-xl font-semibold text-white">Loading question...</h3>
                    
                    <div class="space-y-2">
                        <p id="question-guidance" class="text-gray-400 text-sm italic">Guidance: Loading...</p>
                        <p id="question-action-required" class="text-yellow-400 text-sm font-medium">Action Required: Loading...</p>
                    </div>

                    <!-- Answer Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 pt-4">
                        <button onclick="handleAnswer(1)" class="flex-1 py-3 px-6 bg-primary-green hover:bg-green-600 text-gray-900 font-bold rounded-lg transition duration-150 shadow-lg">
                            Fully Compliant (1)
                        </button>
                        <button onclick="handleAnswer(0.5)" class="flex-1 py-3 px-6 bg-moderate-risk hover:bg-yellow-600 text-gray-900 font-bold rounded-lg transition duration-150 shadow-lg">
                            Partially Compliant (0.5)
                        </button>
                        <button onclick="handleAnswer(0)" class="flex-1 py-3 px-6 bg-high-risk hover:bg-red-600 text-white font-bold rounded-lg transition duration-150 shadow-lg">
                            Not Compliant (0)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Screen (Hidden initially) -->
            <div id="report-screen" class="hidden max-w-4xl mx-auto">
                <div class="bg-card-bg p-8 rounded-xl shadow-2xl space-y-8">
                    <div class="text-center border-b border-gray-700 pb-4">
                        <h2 class="text-4xl font-extrabold text-primary-green mb-2">AI Compliance Assessment Report</h2>
                        <p class="text-lg text-gray-300">Final Audit for: <span id="report-system-description" class="font-medium text-white italic"></span></p>
                    </div>
                    
                    <!-- Summary Card -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        <div class="p-4 rounded-lg border border-gray-700">
                            <p class="text-sm uppercase text-gray-400">Calculated Risk Category</p>
                            <p id="report-risk-level" class="text-2xl font-bold mt-1" style="color:white;"></p>
                        </div>
                        <div class="p-4 rounded-lg border border-gray-700">
                            <p class="text-sm uppercase text-gray-400">Overall Compliance Score</p>
                            <p id="report-compliance-score" class="text-2xl font-bold text-secondary-blue mt-1">--%</p>
                        </div>
                        <div class="p-4 rounded-lg border border-gray-700">
                            <p class="text-sm uppercase text-gray-400">AI Act Risk Level</p>
                            <p id="report-ai-act-risk" class="text-2xl font-bold text-gray-200 mt-1">Loading...</p>
                        </div>
                    </div>

                    <!-- Integrity Hash and Timestamp -->
                    <div class="bg-gray-700 p-4 rounded-lg text-sm space-y-1">
                        <p class="text-gray-400">Audit Integrity Hash (SHA-256): <span id="report-integrity-hash" class="font-mono text-xs text-yellow-400 break-all"></span></p>
                        <p class="text-gray-400">Timestamp: <span id="report-timestamp" class="font-mono text-xs text-gray-300"></span></p>
                    </div>

                    <!-- Domain Breakdown (Radar Chart) -->
                    <div class="pt-4">
                        <h3 class="text-2xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Compliance Domain Breakdown</h3>
                        <div class="flex justify-center">
                            <canvas id="radar-chart" class="max-w-md max-h-96"></canvas>
                        </div>
                    </div>
                    
                    <!-- Actionable Remediation Plan -->
                    <div id="remediation-plan" class="pt-8">
                        <h3 class="text-2xl font-semibold text-white mb-4 border-b border-gray-700 pb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            Actionable Remediation Plan (<span id="remediation-count">0</span> items)
                        </h3>
                        <div id="remediation-list" class="divide-y divide-gray-700">
                            <p class="text-gray-400 italic" id="no-remediation-message">Congratulations! No critical remediation items found.</p>
                        </div>
                    </div>

                    <!-- Footer Actions -->
                    <div class="pt-8 flex flex-col sm:flex-row justify-center gap-4 border-t border-gray-700">
                        <button onclick="window.print()" class="flex items-center justify-center py-3 px-6 bg-secondary-blue hover:bg-blue-600 text-white font-bold rounded-lg transition duration-150 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                            Download Basic PDF Report
                        </button>
                        <button onclick="document.getElementById('welcome-screen').classList.remove('hidden'); document.getElementById('report-screen').classList.add('hidden');" class="flex items-center justify-center py-3 px-6 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg transition duration-150 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M21 12.5c0 .3-.2.5-.5.5h-13c-.2 0-.4-.1-.5-.2-.1-.1-.2-.3-.2-.5s.1-.4.2-.5c.1-.1.3-.2.5-.2h13c.3 0 .5.2.5.5z"></path><path d="M12 21.5c.3 0 .5-.2.5-.5v-13c0-.2-.1-.4-.2-.5-.1-.1-.3-.2-.5-.2s-.4.1-.5.2c-.1.1-.2.3-.2.5v13c0 .3.2.5.5.5z"></path></svg>
                            Start New Session
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Message Box for Custom Alerts/Confirmations (Hidden initially) -->
            <div id="message-box" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-card-bg p-6 rounded-lg shadow-2xl max-w-sm w-full space-y-4">
                    <h4 id="message-title" class="text-xl font-bold text-white">Notification</h4>
                    <p id="message-text" class="text-gray-300">Message content.</p>
                    <div class="flex justify-end">
                        <button onclick="document.getElementById('message-box').classList.add('hidden')" class="py-2 px-4 bg-primary-green hover:bg-green-600 text-gray-900 font-semibold rounded-lg">
                            OK
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="text/javascript">
        // Global State
        let assessmentQuestions = [];
        let currentQuestionIndex = 0;
        let assessmentResults = [];
        let systemDescription = {}; // Changed from string to object
        let aiActRisk = "Minimal Risk (MR)";
        let selectedDomains = [];
        let chartInstance = null;
        
        // Use a generic placeholder if firebase is not ready
        window.userId = window.userId || 'placeholder-user'; 

        // Show the current user ID in the sidebar
        document.addEventListener('DOMContentLoaded', () => {
            const displayUserId = document.getElementById('display-user-id');
            // Wait for auth to complete to display the real ID, otherwise show loading
            if (window.userId && window.userId !== 'anonymous') {
                displayUserId.textContent = window.userId;
            } else {
                // Polling/listener logic from firebase init will update this later
                displayUserId.textContent = 'Authenticating...';
                
                // Simple observer for the auth-status element to update the user ID display
                const authStatusObserver = new MutationObserver(mutations => {
                    mutations.forEach(mutation => {
                        if (mutation.target.textContent.includes('User ID:')) {
                            const match = mutation.target.textContent.match(/User ID: (.+)/);
                            if (match && match[1]) {
                                displayUserId.textContent = match[1];
                            }
                        }
                    });
                });

                const authStatusElement = document.getElementById('auth-status');
                if (authStatusElement) {
                    authStatusObserver.observe(authStatusElement, { childList: true, characterData: true, subtree: true });
                }
            }
        });


        // Assessment Data (Structured Questions)
        const questionsData = [
            // Domain: Data Quality and Governance (Base Risk: 4 - High Importance)
            { domain: "Data Quality and Governance", text: "Are data sources, collection methods, and transformations (ETL/ELT) fully documented and version-controlled?", guidance: "Good data governance requires immutable history of data pipelines.", actionRequired: "Implement a data governance framework to log and version all data sources and transformations.", baseRisk: 4 },
            { domain: "Data Quality and Governance", text: "Are processes in place to monitor data drift and ensure data integrity over time in production?", guidance: "Data integrity and consistency are paramount for model stability.", actionRequired: "Establish data quality checks (e.g., schema validation, constraint checks) to run before model training and inference.", baseRisk: 4 },
            { domain: "Data Quality and Governance", text: "Has a dedicated data bias audit been performed on the training data using fairness metrics?", guidance: "Unaddressed data bias can lead to discriminatory outcomes.", actionRequired: "Conduct a data bias audit using fairness metrics (e.g., demographic parity, equalized odds) and document mitigation strategies.", baseRisk: 5 },

            // Domain: Model Transparency and Explainability (Base Risk: 5 - Very High Importance)
            { domain: "Model Transparency and Explainability", text: "Is there a Model Card or comparable documentation detailing model limits, performance, and ethical considerations?", guidance: "Transparency is a core requirement for regulatory compliance.", actionRequired: "Create and maintain a comprehensive Model Card, including intended use, evaluation metrics, limitations, and ethical considerations.", baseRisk: 5 },
            { domain: "Model Transparency and Explainability", text: "Are explainability techniques (e.g., SHAP, LIME) used to provide clear, human-readable reasons for critical decisions?", guidance: "Users/subjects must understand why a decision was made, especially in high-risk contexts.", actionRequired: "Implement model-agnostic or model-specific explainability tools (like SHAP) to generate explanations for every critical decision.", baseRisk: 5 },
            
            // Domain: Bias and Fairness Assessment (Base Risk: 5 - Very High Importance)
            { domain: "Bias and Fairness Assessment", text: "Are different demographic groups evaluated for performance disparity (e.g., checking False Positive/Negative rates across different protected groups)?", guidance: "Fairness requires checking performance parity, not just overall accuracy.", actionRequired: "Define and test for performance metrics (e.g., FNR, FPR) across all protected groups to ensure equitable outcomes and document any disparities.", baseRisk: 5 },
            { domain: "Bias and Fairness Assessment", text: "Is there a documented process for human oversight and intervention when the model flags a potentially biased or uncertain decision?", guidance: "Human-in-the-loop ensures accountability and error correction.", actionRequired: "Establish a clear human-in-the-loop process with clear decision-making criteria and escalation paths for uncertain or high-risk outcomes.", baseRisk: 4 },
            
            // Domain: Robustness and Security (Base Risk: 3 - Medium Importance)
            { domain: "Robustness and Security", text: "Are resistance measures against adversarial attacks (e.g., input validation, defensive distillation) regularly tested?", guidance: "Adversarial attacks can compromise model integrity and security.", actionRequired: "Implement and regularly test resistance measures against common adversarial attacks like perturbation or data poisoning.", baseRisk: 3 },
            { domain: "Robustness and Security", text: "Is the model's performance monitored in real-time for sudden performance degradation or drift in production?", guidance: "Production monitoring is essential to catch real-world failures and maintain reliability.", actionRequired: "Implement a monitoring dashboard in production to track key metrics (accuracy, drift, latency) and trigger alerts upon deviation.", baseRisk: 3 },

            // Domain: Model Governance and Oversight (Base Risk: 4 - High Importance)
            { domain: "Model Governance and Oversight", text: "Is a dedicated team or committee responsible for reviewing, approving, and overseeing all AI system deployments?", guidance: "Clear accountability and oversight are regulatory requirements.", actionRequired: "Form an official AI Governance Committee with defined roles, responsibilities, and sign-off authority for all AI systems.", baseRisk: 4 },
            { domain: "Model Governance and Oversight", text: "Are all compliance documentation and audit logs (including input data, model versions, and training runs) archived and easily accessible for regulatory review?", guidance: "The ability to audit the entire lifecycle is non-negotiable.", actionRequired: "Establish a secure, version-controlled repository (MLOps pipeline) for archiving all model artifacts, logs, and compliance documentation.", baseRisk: 4 },
        ];


        // Utility function to show custom message box
        const showMessageBox = (title, text) => {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = text;
            document.getElementById('message-box').classList.remove('hidden');
        };

        // --- Core Assessment Logic ---

        document.getElementById('assessment-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Reset state
            currentQuestionIndex = 0;
            assessmentResults = [];
            
            // Collect structured setup data
            const purpose = document.getElementById('system-purpose').value.trim();
            const deployment = document.getElementById('system-deployment').value.trim();
            const impact = document.getElementById('system-impact').value.trim();
            const data = document.getElementById('system-data').value.trim();
            const providerLocation = document.getElementById('system-provider-location').value.trim(); // NEW FIELD

            systemDescription = { purpose, deployment, impact, data, providerLocation };
            
            // Generate a combined, readable description for the report
            const combinedDescription = `${purpose} (Provider: ${providerLocation}, Deployment: ${deployment}, Impact: ${impact}, Data: ${data})`; // Updated combined description

            aiActRisk = document.getElementById('risk-category').options[document.getElementById('risk-category').selectedIndex].text;
            
            const domainCheckboxes = document.querySelectorAll('input[name="domains"]:checked');
            selectedDomains = Array.from(domainCheckboxes).map(cb => cb.value);

            // Updated validation check
            if (!purpose || !deployment || !impact || !data || !providerLocation || selectedDomains.length === 0) {
                 showMessageBox("Input Required", "Please fill in ALL FIVE system context fields and select at least one compliance domain.");
                 return;
            }

            // Filter questions based on selected domains
            assessmentQuestions = questionsData.filter(q => selectedDomains.includes(q.domain));

            if (assessmentQuestions.length === 0) {
                showMessageBox("No Questions", "Please select at least one compliance domain to run the assessment.");
                return;
            }
            
            // Switch UI to assessment screen
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('report-screen').classList.add('hidden');
            document.getElementById('assessment-screen').classList.remove('hidden');

            // Set total question count
            document.getElementById('current-question-indicator').textContent = `1 / ${assessmentQuestions.length}`;
            
            // Store the combined description for the report header
            window.combinedDescription = combinedDescription; 
            
            loadQuestion();
        });

        const loadQuestion = () => {
            if (currentQuestionIndex < assessmentQuestions.length) {
                const q = assessmentQuestions[currentQuestionIndex];
                
                document.getElementById('question-domain').textContent = `DOMAIN: ${q.domain}`;
                document.getElementById('question-text').textContent = q.text;
                document.getElementById('question-guidance').textContent = `Guidance: ${q.guidance}`;
                document.getElementById('question-action-required').textContent = `Action Required: ${q.actionRequired}`;
                document.getElementById('current-question-indicator').textContent = `${currentQuestionIndex + 1} / ${assessmentQuestions.length}`;
                
                updateProgressBar();
            } else {
                // Assessment is complete
                generateReport();
            }
        };

        const updateProgressBar = () => {
            const progress = (currentQuestionIndex / assessmentQuestions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        };

        window.handleAnswer = (score) => {
            const q = assessmentQuestions[currentQuestionIndex];
            
            assessmentResults.push({
                domain: q.domain,
                question: q.text,
                actionRequired: q.actionRequired,
                score: score,
                baseRisk: q.baseRisk,
                weightedScore: score * q.baseRisk
            });
            
            currentQuestionIndex++;
            loadQuestion();
        };

        // --- Report Generation and Saving ---

        const calculateMetrics = () => {
            let totalWeightedScore = 0;
            let totalPossibleWeightedScore = 0;
            const domainScores = {};

            // Initialize domain scores
            selectedDomains.forEach(domain => {
                domainScores[domain] = { current: 0, possible: 0 };
            });

            assessmentResults.forEach(r => {
                totalWeightedScore += r.weightedScore;
                totalPossibleWeightedScore += r.baseRisk;

                domainScores[r.domain].current += r.weightedScore;
                domainScores[r.domain].possible += r.baseRisk;
            });

            const overallComplianceScore = totalPossibleWeightedScore > 0 
                ? (totalWeightedScore / totalPossibleWeightedScore) * 100 
                : 0;

            // Calculate domain compliance percentages
            const domainPercentages = {};
            for (const domain in domainScores) {
                const score = domainScores[domain];
                domainPercentages[domain] = score.possible > 0 
                    ? (score.current / score.possible) * 100 
                    : 0;
            }

            return { overallComplianceScore, totalPossibleWeightedScore, totalWeightedScore, domainPercentages };
        };

        const generateReport = async () => {
            // Calculate final scores
            const { overallComplianceScore, totalPossibleWeightedScore, totalWeightedScore, domainPercentages } = calculateMetrics();

            // Determine Risk Level (0-40% = HIGH, 41-75% = MODERATE, 76-100% = LOW)
            let calculatedRiskLevel = 'HIGH';
            let riskColor = 'text-high-risk';
            
            if (overallComplianceScore > 75) {
                calculatedRiskLevel = 'LOW';
                riskColor = 'text-low-risk';
            } else if (overallComplianceScore > 40) {
                calculatedRiskLevel = 'MODERATE';
                riskColor = 'text-moderate-risk';
            }

            // Create the Audit Integrity Hash
            const dataToHash = JSON.stringify({
                system: systemDescription, // Now includes the structured details
                risk: aiActRisk,
                score: overallComplianceScore.toFixed(2),
                weightedScore: totalWeightedScore,
                results: assessmentResults.map(r => ({ q: r.question, s: r.score }))
            });
            const integrityHash = CryptoJS.SHA256(dataToHash).toString(CryptoJS.enc.Hex);
            const reportTimestamp = new Date().toLocaleString();
            
            // --- Save to Firestore ---
            await saveAssessment({
                userId: window.userId,
                appId: appId,
                timestamp: serverTimestamp(),
                reportTimestamp: reportTimestamp,
                systemDescription: systemDescription, // Save as object with 5 fields
                combinedDescription: window.combinedDescription, // Save the readable string for quick review
                aiActRisk,
                calculatedRiskLevel,
                overallComplianceScore: parseFloat(overallComplianceScore.toFixed(2)),
                integrityHash,
                totalWeightedScore,
                totalPossibleWeightedScore,
                domainPercentages,
                results: assessmentResults
            });


            // --- Update UI ---
            document.getElementById('assessment-screen').classList.add('hidden');
            document.getElementById('report-system-description').textContent = window.combinedDescription;
            document.getElementById('report-ai-act-risk').textContent = aiActRisk;
            
            const riskLevelEl = document.getElementById('report-risk-level');
            riskLevelEl.textContent = `${calculatedRiskLevel} LIABILITY`;
            riskLevelEl.className = `text-2xl font-bold mt-1 ${riskColor}`;
            
            document.getElementById('report-compliance-score').textContent = `${overallComplianceScore.toFixed(2)}%`;
            document.getElementById('report-integrity-hash').textContent = integrityHash;
            document.getElementById('report-timestamp').textContent = reportTimestamp;
            
            renderRemediationPlan();
            renderRadarChart(domainPercentages);

            document.getElementById('report-screen').classList.remove('hidden');
            updateProgressBar(); // Ensure progress bar is full
        };

        const saveAssessment = async (data) => {
            try {
                if (!window.db || !window.userId) {
                    throw new Error("Firestore not initialized or User ID not available.");
                }
                
                const collectionPath = `artifacts/${appId}/users/${window.userId}/assessments`;
                
                await addDoc(collection(window.db, collectionPath), data);
                console.log("Assessment saved successfully.");

            } catch (error) {
                console.error("Error saving assessment to Firestore:", error);
                showMessageBox("Save Error", "Failed to save the assessment report to the database. Check console for details.");
            }
        };

        const renderRemediationPlan = () => {
            const listEl = document.getElementById('remediation-list');
            listEl.innerHTML = '';
            document.getElementById('no-remediation-message').classList.add('hidden');

            const remediationItems = assessmentResults.filter(r => r.score < 1);
            
            document.getElementById('remediation-count').textContent = remediationItems.length;

            if (remediationItems.length === 0) {
                document.getElementById('no-remediation-message').classList.remove('hidden');
                return;
            }

            remediationItems.forEach((item, index) => {
                const riskColor = item.score === 0 ? 'text-high-risk' : 'text-moderate-risk';
                const statusText = item.score === 0 ? 'FAIL (0)' : 'PARTIAL (0.5)';

                listEl.innerHTML += `
                    <div class="remediation-item">
                        <div class="w-1/12 text-center pt-1">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${item.score === 0 ? '#ef4444' : '#f59e0b'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        </div>
                        <div class="w-11/12">
                            <p class="text-sm font-bold text-gray-200 mb-1">${index + 1}. ${item.question}</p>
                            <p class="text-xs ${riskColor} font-semibold">Status: ${statusText}</p>
                            <p class="text-xs text-gray-300 mt-1"><span class="font-bold text-primary-green">ACTION:</span> ${item.actionRequired}</p>
                        </div>
                    </div>
                `;
            });
        };

        const renderRadarChart = (domainPercentages) => {
            if (chartInstance) {
                chartInstance.destroy();
            }

            const labels = Object.keys(domainPercentages);
            const dataValues = Object.values(domainPercentages).map(val => parseFloat(val.toFixed(1)));
            
            const ctx = document.getElementById('radar-chart').getContext('2d');
            
            // Register plugin globally
            Chart.register(ChartDataLabels);

            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Compliance Score (%)',
                        data: dataValues,
                        backgroundColor: 'rgba(16, 185, 129, 0.4)', // Primary Green transparent
                        borderColor: '#10b981', // Primary Green
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#10b981',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.2)' },
                            grid: { color: 'rgba(255, 255, 255, 0.2)' },
                            pointLabels: { color: '#e5e7eb', font: { size: 12, weight: '600' } },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: {
                                display: true,
                                color: '#9ca3af',
                                backdropColor: '#334155', // Match card background
                                beginAtZero: true,
                                stepSize: 25,
                                callback: function(value) { return value + "%"; }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false 
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => ` ${context.dataset.label}: ${context.parsed.r.toFixed(1)}%`
                            }
                        },
                        datalabels: {
                            color: '#e5e7eb',
                            font: { weight: 'bold', size: 10 },
                            formatter: (value) => `${value.toFixed(0)}%`,
                            display: true,
                            anchor: 'end',
                            align: 'end',
                            offset: 5
                        }
                    }
                }
            });
        };
    </script>
</body>
</html>
